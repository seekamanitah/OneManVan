@page "/warranties/claims/add"
@using Microsoft.EntityFrameworkCore
@using OneManVan.Shared.Data
@using OneManVan.Shared.Models
@using OneManVan.Shared.Models.Enums
@attribute [Authorize]
@inject IDbContextFactory<OneManVanDbContext> DbFactory
@inject NavigationManager Navigation

<PageTitle>File Warranty Claim - OneManVan</PageTitle>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-0">File Warranty Claim</h1>
                    <p class="text-muted mb-0">Submit a new warranty claim for equipment repair</p>
                </div>
                <button class="btn btn-outline-secondary" @onclick="Cancel">
                    <i class="bi bi-x-lg me-2"></i>Cancel
                </button>
            </div>

            <EditForm Model="claim" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <!-- Asset Selection -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">1. Select Asset</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Asset <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="claim.AssetId" @bind:after="OnAssetSelected">
                                <option value="0">-- Select Asset --</option>
                                @foreach (var asset in assets)
                                {
                                    <option value="@asset.Id">
                                        @asset.AssetTag - @asset.Description (@asset.Customer?.Name)
                                    </option>
                                }
                            </select>
                            <ValidationMessage For="@(() => claim.AssetId)" />
                        </div>

                        @if (selectedAsset != null)
                        {
                            <div class="alert alert-info">
                                <h6 class="alert-heading">Asset Information</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Customer:</strong> @selectedAsset.Customer?.Name<br />
                                        <strong>Asset Tag:</strong> @selectedAsset.AssetTag<br />
                                        <strong>Description:</strong> @selectedAsset.Description
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Install Date:</strong> @(selectedAsset.InstallDate?.ToString("MMM dd, yyyy") ?? "-")<br />
                                        <strong>Warranty Expires:</strong> 
                                        @if (selectedAsset.WarrantyExpiration.HasValue)
                                        {
                                            var isExpired = selectedAsset.WarrantyExpiration.Value < DateTime.Today;
                                            <span class="@(isExpired ? "text-danger" : "text-success")">
                                                @selectedAsset.WarrantyExpiration.Value.ToString("MMM dd, yyyy")
                                                @if (isExpired)
                                                {
                                                    <text>(EXPIRED)</text>
                                                }
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not set</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Claim Details -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0">2. Claim Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Claim Number -->
                            <div class="col-md-6">
                                <label class="form-label">Claim Number</label>
                                <InputText @bind-Value="claim.ClaimNumber" class="form-control" 
                                           placeholder="Auto-generated if blank" />
                                <small class="text-muted">Leave blank to auto-generate</small>
                            </div>

                            <!-- Claim Date -->
                            <div class="col-md-6">
                                <label class="form-label">Claim Date <span class="text-danger">*</span></label>
                                <InputDate @bind-Value="claim.ClaimDate" class="form-control" />
                                <ValidationMessage For="@(() => claim.ClaimDate)" />
                            </div>

                            <!-- Issue Description -->
                            <div class="col-12">
                                <label class="form-label">Issue Description <span class="text-danger">*</span></label>
                                <InputTextArea @bind-Value="claim.IssueDescription" class="form-control" rows="4" 
                                               placeholder="Describe the issue or failure..." />
                                <ValidationMessage For="@(() => claim.IssueDescription)" />
                            </div>

                            <!-- Warranty Coverage -->
                            <div class="col-md-6">
                                <label class="form-label">Warranty Coverage</label>
                                <div class="form-check form-switch">
                                    <InputCheckbox @bind-Value="claim.IsCoveredByWarranty" class="form-check-input" id="coverageSwitch" />
                                    <label class="form-check-label" for="coverageSwitch">
                                        Covered by Warranty
                                    </label>
                                </div>
                            </div>

                            @if (!claim.IsCoveredByWarranty)
                            {
                                <div class="col-md-6">
                                    <label class="form-label">Reason Not Covered</label>
                                    <InputText @bind-Value="claim.NotCoveredReason" class="form-control" 
                                               placeholder="e.g., Warranty expired, misuse, etc." />
                                </div>
                            }

                            <!-- Financial -->
                            <div class="col-md-6">
                                <label class="form-label">Estimated Repair Cost</label>
                                <InputNumber @bind-Value="claim.RepairCost" class="form-control" step="0.01" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Customer Charge</label>
                                <InputNumber @bind-Value="claim.CustomerCharge" class="form-control" step="0.01" />
                                <small class="text-muted">Amount customer will pay if not fully covered</small>
                            </div>

                            <!-- Parts Replaced -->
                            <div class="col-12">
                                <label class="form-label">Parts to Replace</label>
                                <InputTextArea @bind-Value="claim.PartsReplaced" class="form-control" rows="2" 
                                               placeholder="List parts that need replacement..." />
                            </div>

                            <!-- Technician Notes -->
                            <div class="col-12">
                                <label class="form-label">Technician Notes</label>
                                <InputTextArea @bind-Value="claim.TechnicianNotes" class="form-control" rows="3" 
                                               placeholder="Additional notes about the issue..." />
                            </div>

                            <!-- Filed By -->
                            <div class="col-md-6">
                                <label class="form-label">Filed By</label>
                                <InputText @bind-Value="claim.FiledBy" class="form-control" 
                                           placeholder="Your name" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        @errorMessage
                    </div>
                }

                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-check-circle me-2"></i>File Claim
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
[Parameter]
[SupplyParameterFromQuery]
public int? AssetId { get; set; }

private bool isSaving = false;
private WarrantyClaim claim = new();
private Asset? selectedAsset;
private List<Asset> assets = new();
private string errorMessage = "";

protected override async Task OnInitializedAsync()
{
    await LoadAssetsAsync();
        
    // Set default values
    claim.ClaimDate = DateTime.Today;
    claim.IsCoveredByWarranty = true;
    claim.Status = ClaimStatus.Pending;

    // Pre-select asset if provided via query parameter
    if (AssetId.HasValue && AssetId.Value > 0)
    {
        claim.AssetId = AssetId.Value;
        await OnAssetSelected();
    }
}

    private async Task LoadAssetsAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        assets = await db.Assets
            .Include(a => a.Customer)
            .Where(a => a.Status == AssetStatus.Active)
            .OrderBy(a => a.Customer!.Name)
            .ThenBy(a => a.AssetTag)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task OnAssetSelected()
    {
        if (claim.AssetId > 0)
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            selectedAsset = await db.Assets
                .Include(a => a.Customer)
                .FirstOrDefaultAsync(a => a.Id == claim.AssetId);
        }
        else
        {
            selectedAsset = null;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSaving = true;
            errorMessage = "";

            if (claim.AssetId == 0)
            {
                errorMessage = "Please select an asset.";
                return;
            }

            await using var db = await DbFactory.CreateDbContextAsync();

            // Auto-generate claim number if not provided
            if (string.IsNullOrWhiteSpace(claim.ClaimNumber))
            {
                var nextId = await db.WarrantyClaims.CountAsync() + 1;
                claim.ClaimNumber = $"CLM-{nextId:D4}";
            }

            claim.CreatedAt = DateTime.UtcNow;
            db.WarrantyClaims.Add(claim);
            await db.SaveChangesAsync();

            // Navigate to claim detail
            Navigation.NavigateTo($"/warranties/claims/{claim.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error filing claim: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/warranties/claims");
    }
}
