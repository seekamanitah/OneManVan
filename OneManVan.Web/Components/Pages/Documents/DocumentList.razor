@page "/documents"
@using Microsoft.EntityFrameworkCore
@using OneManVan.Shared.Data
@using OneManVan.Shared.Models
@using OneManVan.Shared.Models.Enums
@using OneManVan.Shared.Services
@inject DocumentService DocumentService
@inject NavigationManager Navigation

<PageTitle>Document Library - OneManVan</PageTitle>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Document Library</h1>
            <small class="text-muted">Service manuals, technical guides, and business templates</small>
        </div>
        <div class="d-flex gap-2">
            <ExportButton EntityType="documents" />
            <a href="/documents/upload" class="btn btn-primary">
                <i class="bi bi-cloud-upload me-2"></i>Upload Document
            </a>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" 
                               placeholder="Search documents by name, manufacturer, model, keywords..." 
                               @bind="searchQuery" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
                        @if (!string.IsNullOrEmpty(searchQuery))
                        {
                            <button class="btn btn-outline-secondary" @onclick="ClearSearch">
                                <i class="bi bi-x"></i>
                            </button>
                        }
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="selectedCategory" @bind:after="ApplyFilters">
                        <option value="">All Categories</option>
                        @foreach (var cat in Enum.GetValues<DocumentCategory>())
                        {
                            <option value="@cat">@GetCategoryDisplayName(cat)</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="selectedManufacturer" @bind:after="ApplyFilters">
                        <option value="">All Manufacturers</option>
                        @foreach (var mfr in manufacturers)
                        {
                            <option value="@mfr">@mfr</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filters -->
    <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn @(showFavoritesOnly ? "btn-warning" : "btn-outline-warning") btn-sm" @onclick="ToggleFavoritesFilter">
            <i class="bi bi-star-fill me-1"></i>Favorites
        </button>
        <button class="btn @(showRecentOnly ? "btn-info" : "btn-outline-info") btn-sm" @onclick="ToggleRecentFilter">
            <i class="bi bi-clock me-1"></i>Recent
        </button>
        <button class="btn @(showCustomOnly ? "btn-success" : "btn-outline-success") btn-sm" @onclick="ToggleCustomFilter">
            <i class="bi bi-file-earmark-plus me-1"></i>Custom Documents
        </button>
        @if (categoryStats.Any())
        {
            <div class="ms-auto">
                <span class="text-muted small">@filteredDocuments.Count of @allDocuments.Count documents</span>
            </div>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!filteredDocuments.Any())
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-folder2-open display-1 text-muted"></i>
                <h5 class="mt-3">No documents found</h5>
                <p class="text-muted">
                    @if (!string.IsNullOrEmpty(searchQuery))
                    {
                        <span>No documents match your search criteria.</span>
                    }
                    else
                    {
                        <span>Start by uploading service manuals, technical guides, or business templates.</span>
                    }
                </p>
                <a href="/documents/upload" class="btn btn-primary">
                    <i class="bi bi-cloud-upload me-2"></i>Upload First Document
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Category Tabs (when no filter applied) -->
        @if (string.IsNullOrEmpty(searchQuery) && !showFavoritesOnly && !showRecentOnly && !showCustomOnly && selectedCategory == null)
        {
            <div class="row g-3 mb-4">
                @foreach (var catGroup in filteredDocuments.GroupBy(d => d.Category).OrderBy(g => g.Key))
                {
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi @GetCategoryIcon(catGroup.Key) me-2 text-primary"></i>
                                    @GetCategoryDisplayName(catGroup.Key)
                                </h5>
                                <span class="badge bg-secondary">@catGroup.Count()</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 40px;"></th>
                                                <th>Document</th>
                                                <th>Manufacturer</th>
                                                <th>Type</th>
                                                <th>Size</th>
                                                <th style="width: 100px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var doc in catGroup.Take(5))
                                            {
                                                <tr class="cursor-pointer" @onclick="() => ViewDocument(doc.Id)">
                                                    <td class="text-center">
                                                        <i class="bi @doc.FileTypeIcon fs-5"></i>
                                                    </td>
                                                    <td>
                                                        <div class="fw-medium">
                                                            @if (doc.IsFavorite)
                                                            {
                                                                <i class="bi bi-star-fill text-warning me-1"></i>
                                                            }
                                                            @doc.Name
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(doc.Description))
                                                        {
                                                            <small class="text-muted">@(doc.Description.Length > 60 ? doc.Description[..60] + "..." : doc.Description)</small>
                                                        }
                                                    </td>
                                                    <td>@(doc.Manufacturer ?? "-")</td>
                                                    <td>@doc.FileExtension?.ToUpper().TrimStart('.')</td>
                                                    <td>@doc.FileSizeDisplay</td>
                                                    <td @onclick:stopPropagation="true">
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="/documents/@doc.Id" class="btn btn-outline-primary" title="View">
                                                                <i class="bi bi-eye"></i>
                                                            </a>
                                                            <button class="btn btn-outline-warning" @onclick="() => ToggleFavorite(doc)" title="@(doc.IsFavorite ? "Remove from favorites" : "Add to favorites")">
                                                                <i class="bi @(doc.IsFavorite ? "bi-star-fill" : "bi-star")"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                @if (catGroup.Count() > 5)
                                {
                                    <div class="text-center py-2 bg-light">
                                        <button class="btn btn-link btn-sm" @onclick="() => FilterByCategory(catGroup.Key)">
                                            View all @catGroup.Count() documents in this category
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Full List View -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Document</th>
                                    <th>Category</th>
                                    <th>Manufacturer</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Views</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var doc in filteredDocuments)
                                {
                                    <tr class="cursor-pointer" @onclick="() => ViewDocument(doc.Id)">
                                        <td class="text-center">
                                            <i class="bi @doc.FileTypeIcon fs-5"></i>
                                        </td>
                                        <td>
                                            <div class="fw-medium">
                                                @if (doc.IsFavorite)
                                                {
                                                    <i class="bi bi-star-fill text-warning me-1"></i>
                                                }
                                                @if (doc.IsCustomDocument)
                                                {
                                                    <span class="badge bg-success me-1">Custom</span>
                                                }
                                                @doc.Name
                                            </div>
                                            @if (!string.IsNullOrEmpty(doc.Description))
                                            {
                                                <small class="text-muted">@(doc.Description.Length > 80 ? doc.Description[..80] + "..." : doc.Description)</small>
                                            }
                                            @if (doc.TagList.Any())
                                            {
                                                <div class="mt-1">
                                                    @foreach (var tag in doc.TagList.Take(3))
                                                    {
                                                        <span class="badge bg-light text-dark me-1">@tag</span>
                                                    }
                                                </div>
                                            }
                                        </td>
                                        <td><span class="badge bg-primary bg-opacity-10 text-primary">@doc.CategoryDisplay</span></td>
                                        <td>@(doc.Manufacturer ?? "-")</td>
                                        <td>@doc.FileExtension?.ToUpper().TrimStart('.')</td>
                                        <td>@doc.FileSizeDisplay</td>
                                        <td>@doc.ViewCount</td>
                                        <td @onclick:stopPropagation="true">
                                            <div class="btn-group btn-group-sm">
                                                <a href="/documents/@doc.Id" class="btn btn-outline-primary" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <button class="btn btn-outline-warning" @onclick="() => ToggleFavorite(doc)" title="@(doc.IsFavorite ? "Remove from favorites" : "Add to favorites")">
                                                    <i class="bi @(doc.IsFavorite ? "bi-star-fill" : "bi-star")"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" @onclick="() => DeleteDocument(doc)" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .cursor-pointer {
        cursor: pointer;
    }
    .cursor-pointer:hover {
        background-color: rgba(0,0,0,0.02);
    }
</style>

@code {
    private List<Document> allDocuments = new();
    private List<Document> filteredDocuments = new();
    private List<string> manufacturers = new();
    private Dictionary<DocumentCategory, int> categoryStats = new();
    
    private bool isLoading = true;
    private string searchQuery = "";
    private DocumentCategory? selectedCategory = null;
    private string selectedManufacturer = "";
    private bool showFavoritesOnly = false;
    private bool showRecentOnly = false;
    private bool showCustomOnly = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        
        allDocuments = await DocumentService.GetAllAsync();
        manufacturers = await DocumentService.GetManufacturersAsync();
        categoryStats = await DocumentService.GetCategoryCountsAsync();
        
        ApplyFilters();
        isLoading = false;
    }

    private void ApplyFilters()
    {
        var query = allDocuments.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            query = query.Where(d => d.MatchesSearch(searchQuery));
        }

        // Category filter
        if (selectedCategory.HasValue)
        {
            query = query.Where(d => d.Category == selectedCategory.Value);
        }

        // Manufacturer filter
        if (!string.IsNullOrEmpty(selectedManufacturer))
        {
            query = query.Where(d => d.Manufacturer == selectedManufacturer);
        }

        // Quick filters
        if (showFavoritesOnly)
        {
            query = query.Where(d => d.IsFavorite);
        }

        if (showCustomOnly)
        {
            query = query.Where(d => d.IsCustomDocument);
        }

        if (showRecentOnly)
        {
            query = query.Where(d => d.LastAccessedAt != null)
                        .OrderByDescending(d => d.LastAccessedAt)
                        .Take(10);
        }

        filteredDocuments = query.ToList();
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        ApplyFilters();
    }

    private void ClearSearch()
    {
        searchQuery = "";
        ApplyFilters();
    }

    private void FilterByCategory(DocumentCategory category)
    {
        selectedCategory = category;
        ApplyFilters();
    }

    private void ToggleFavoritesFilter()
    {
        showFavoritesOnly = !showFavoritesOnly;
        showRecentOnly = false;
        showCustomOnly = false;
        ApplyFilters();
    }

    private void ToggleRecentFilter()
    {
        showRecentOnly = !showRecentOnly;
        showFavoritesOnly = false;
        showCustomOnly = false;
        ApplyFilters();
    }

    private void ToggleCustomFilter()
    {
        showCustomOnly = !showCustomOnly;
        showFavoritesOnly = false;
        showRecentOnly = false;
        ApplyFilters();
    }

    private void ViewDocument(int id)
    {
        Navigation.NavigateTo($"/documents/{id}");
    }

    private async Task ToggleFavorite(Document doc)
    {
        doc.IsFavorite = await DocumentService.ToggleFavoriteAsync(doc.Id);
        StateHasChanged();
    }

    private async Task DeleteDocument(Document doc)
    {
        await DocumentService.DeleteAsync(doc.Id);
        allDocuments.Remove(doc);
        ApplyFilters();
    }

    private string GetCategoryDisplayName(DocumentCategory cat) => cat switch
    {
        DocumentCategory.ServiceManual => "Service Manuals",
        DocumentCategory.InstallationGuide => "Installation Guides",
        DocumentCategory.TechnicalSpec => "Technical Specifications",
        DocumentCategory.WiringDiagram => "Wiring Diagrams",
        DocumentCategory.PartsManual => "Parts Manuals",
        DocumentCategory.WarrantyInfo => "Warranty Information",
        DocumentCategory.SafetyData => "Safety Data Sheets",
        DocumentCategory.MaintenanceGuide => "Maintenance Guides",
        DocumentCategory.TroubleshootingGuide => "Troubleshooting Guides",
        DocumentCategory.CustomerForm => "Customer Forms",
        DocumentCategory.BusinessTemplate => "Business Templates",
        DocumentCategory.Checklist => "Checklists",
        DocumentCategory.Training => "Training Materials",
        DocumentCategory.Compliance => "Compliance Documents",
        DocumentCategory.Brochure => "Brochures",
        _ => "General"
    };

    private string GetCategoryIcon(DocumentCategory cat) => cat switch
    {
        DocumentCategory.ServiceManual => "bi-tools",
        DocumentCategory.InstallationGuide => "bi-wrench",
        DocumentCategory.TechnicalSpec => "bi-file-text",
        DocumentCategory.WiringDiagram => "bi-diagram-3",
        DocumentCategory.PartsManual => "bi-puzzle",
        DocumentCategory.WarrantyInfo => "bi-shield-check",
        DocumentCategory.SafetyData => "bi-exclamation-triangle",
        DocumentCategory.MaintenanceGuide => "bi-calendar-check",
        DocumentCategory.TroubleshootingGuide => "bi-question-circle",
        DocumentCategory.CustomerForm => "bi-person-lines-fill",
        DocumentCategory.BusinessTemplate => "bi-file-earmark-ruled",
        DocumentCategory.Checklist => "bi-list-check",
        DocumentCategory.Training => "bi-mortarboard",
        DocumentCategory.Compliance => "bi-clipboard-check",
        DocumentCategory.Brochure => "bi-images",
        _ => "bi-file-earmark"
    };
}
