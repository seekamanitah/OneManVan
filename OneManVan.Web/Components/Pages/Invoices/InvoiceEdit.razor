@page "/invoices/new"
@page "/invoices/{Id:int}/edit"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using OneManVan.Shared.Data
@using OneManVan.Shared.Models
@using OneManVan.Shared.Models.Enums
@using OneManVan.Shared.Services
@implements IDisposable

@inject IDbContextFactory<OneManVanDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ISettingsStorage SettingsStorage
@inject INotificationService NotificationService
@inject IEmployeeTimeLogAutoService TimeLogAutoService


<PageTitle>@(IsNew ? "New Invoice" : $"Edit Invoice") - OneManVan</PageTitle>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/invoices">Invoices</a></li>
                        <li class="breadcrumb-item active">@(IsNew ? "New" : "Edit")</li>
                    </ol>
                </nav>
                <h1 class="h2">@(IsNew ? "New Invoice" : $"Edit: {model.InvoiceNumber}")</h1>
            </div>

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            }
            else
            {
                <Microsoft.AspNetCore.Components.Routing.NavigationLock 
                    ConfirmExternalNavigation="@isDirty" 
                    OnBeforeInternalNavigation="OnBeforeInternalNavigation" />
                
                <EditForm EditContext="@editContext" OnSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    <!-- Basic Info -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0">Invoice Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Customer *</label>
                                    <InputSelect class="form-select" @bind-Value="model.CustomerId">
                                        <option value="0">Select customer...</option>
                                        @foreach (var customer in customers)
                                        {
                                            <option value="@customer.Id">@customer.Name</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => model.CustomerId)" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Status</label>
                                    <InputSelect class="form-select" @bind-Value="model.Status">
                                        @foreach (var s in Enum.GetValues<InvoiceStatus>())
                                        {
                                            <option value="@s">@s</option>
                                        }
                                    </InputSelect>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Invoice Date</label>
                                    <InputDate class="form-control" @bind-Value="model.InvoiceDate" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Due Date</label>
                                    <InputDate class="form-control" @bind-Value="model.DueDate" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Pricing Type</label>
                                    <InputSelect class="form-select" @bind-Value="model.PricingType" @bind-Value:after="OnPricingTypeChanged">
                                        <option value="@InvoicePricingType.MaterialAndLabor">Material & Labor (Itemized)</option>
                                        <option value="@InvoicePricingType.FlatRate">Flat Rate</option>
                                        <option value="@InvoicePricingType.TimeAndMaterials">Time & Materials</option>
                                    </InputSelect>
                                    <small class="text-muted">Choose how to structure pricing on this invoice</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* Flat Rate Section - shown when PricingType is FlatRate *@
                    @if (model.PricingType == InvoicePricingType.FlatRate)
                    {
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0">Flat Rate Pricing</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Flat Rate Amount *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <InputNumber class="form-control" @bind-Value="model.FlatRateAmount" @bind-Value:after="RecalculateTotals" min="0.01" step="0.01" />
                                        </div>
                                        <ValidationMessage For="@(() => model.FlatRateAmount)" />
                                        @if (model.FlatRateAmount <= 0)
                                        {
                                            <small class="text-danger">Amount must be greater than zero</small>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Description</label>
                                        <InputText class="form-control" @bind-Value="model.FlatRateDescription" placeholder="e.g., Complete AC System Tune-Up" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    @* Line Items - shown when not FlatRate *@
                    @if (model.PricingType != InvoicePricingType.FlatRate)
                    {
                    <!-- Line Items -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white border-0 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Parts & Materials</h5>
                                <button type="button" class="btn btn-sm btn-primary" @onclick="AddLineItem">
                                    <i class="bi bi-plus-circle"></i> Add Item
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (lineItems.Count == 0)
                            {
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                    <p class="mt-2">No items yet. Click "Add Item" to get started.</p>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th style="width: 40%">Description</th>
                                                <th style="width: 15%" class="text-end">Quantity</th>
                                                <th style="width: 15%" class="text-end">Unit Price</th>
                                                <th style="width: 15%" class="text-end">Total</th>
                                                <th style="width: 15%" class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in lineItems)
                                            {
                                                <tr>
                                                    <td>
                                                        <strong>@item.Description</strong>
                                                        @if (!string.IsNullOrEmpty(item.Notes))
                                                        {
                                                            <br />
                                                            <small class="text-muted">@item.Notes</small>
                                                        }
                                                    </td>
                                                    <td class="text-end">@item.Quantity.ToString("N2")</td>
                                                    <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                                    <td class="text-end"><strong>@item.Total.ToString("C")</strong></td>
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditLineItem(item)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => DeleteLineItem(item)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-secondary">
                                                <td colspan="3" class="text-end"><strong>Parts Subtotal:</strong></td>
                                                <td class="text-end"><strong>@lineItems.Sum(i => i.Total).ToString("C")</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Labor/Time Section -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white border-0 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Labor & Time (Optional)</h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AddLaborItem">
                                    <i class="bi bi-plus-circle"></i> Add Labor
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (laborItems.Count == 0)
                            {
                                <div class="text-center text-muted py-3">
                                    <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                                    <p class="mt-2 small">No labor charges. Click "Add Labor" to add time/labor costs.</p>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th style="width: 40%">Description</th>
                                                <th style="width: 15%" class="text-end">Hours</th>
                                                <th style="width: 15%" class="text-end">Rate/Hour</th>
                                                <th style="width: 15%" class="text-end">Total</th>
                                                <th style="width: 15%" class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in laborItems)
                                            {
                                                <tr>
                                                    <td>
                                                        <strong>@item.Description</strong>
                                                        @if (!string.IsNullOrEmpty(item.Notes))
                                                        {
                                                            <br />
                                                            <small class="text-muted">@item.Notes</small>
                                                        }
                                                    </td>
                                                    <td class="text-end">@item.Quantity.ToString("N2")</td>
                                                    <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                                    <td class="text-end"><strong>@item.Total.ToString("C")</strong></td>
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditLaborItem(item)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => DeleteLaborItem(item)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-secondary">
                                                <td colspan="3" class="text-end"><strong>Labor Subtotal:</strong></td>
                                                <td class="text-end"><strong>@laborItems.Sum(i => i.Total).ToString("C")</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                    } @* End of line items conditional *@

                    <!-- Totals (Read-Only, Calculated) -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0">Invoice Totals</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Subtotal (Parts + Labor)</label>
                                    <input type="text" class="form-control bg-light" value="@CalculatedSubtotal.ToString("C")" disabled />
                                    <small class="text-muted">Automatically calculated from line items</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label d-flex justify-content-between align-items-center">
                                        <span>Tax Rate (%)</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ResetToGlobalTaxRate" title="Reset to global default">
                                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                                        </button>
                                    </label>
                                    <InputNumber class="form-control" @bind-Value="model.TaxRate" step="0.01" @oninput="RecalculateTotals" disabled="@model.TaxIncluded" />
                                    <small class="text-muted">Current default: @defaultTaxRate%</small>
                                </div>
                                <div class="col-12">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="model.TaxIncluded" @onchange="RecalculateTotals" />
                                        <label class="form-check-label">Tax Already Included in Price (flat rate with tax)</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tax Amount</label>
                                    @if (model.TaxIncluded)
                                    {
                                        <input type="text" class="form-control bg-light" value="Included" disabled />
                                    }
                                    else
                                    {
                                        <input type="text" class="form-control bg-light" value="@CalculatedTaxAmount.ToString("C")" disabled />
                                    }
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Total</label>
                                    <input type="text" class="form-control bg-light fw-bold" value="@CalculatedTotal.ToString("C")" disabled />
                                    <small class="text-muted">Automatically calculated</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Amount Paid</label>
                                    <InputNumber class="form-control" @bind-Value="model.AmountPaid" step="0.01" @oninput="RecalculateTotals" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Balance Due</label>
                                    <input type="text" class="form-control bg-warning bg-opacity-25 fw-bold" value="@((CalculatedTotal - model.AmountPaid).ToString("C"))" disabled />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0">Notes & Terms</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Notes</label>
                                    <InputTextArea class="form-control" rows="3" @bind-Value="model.Notes" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Terms</label>
                                    <InputTextArea class="form-control" rows="2" @bind-Value="model.Terms" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" class="btn btn-outline-secondary" @onclick="Cancel" disabled="@isSaving">
                                    Cancel
                                </button>
                                <div class="d-flex gap-2">
                                    @if (!IsNew)
                                    {
                                        @if (!model.IsDeleted)
                                        {
                                            <!-- Invoice is active - show delete button -->
                                            <button type="button" class="btn btn-outline-warning" @onclick="SoftDeleteInvoice" disabled="@isSaving">
                                                <i class="bi bi-archive me-2"></i>Delete
                                            </button>
                                        }
                                        else
                                        {
                                            <!-- Invoice is deleted - show restore and permanent delete -->
                                            <button type="button" class="btn btn-outline-success" @onclick="RestoreInvoice" disabled="@isSaving">
                                                <i class="bi bi-arrow-counterclockwise me-2"></i>Restore
                                            </button>
                                            <button type="button" class="btn btn-danger" @onclick="HardDeleteInvoice" disabled="@isSaving">
                                                <i class="bi bi-trash me-2"></i>Delete Permanently
                                            </button>
                                        }
                                    }
                                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-check-circle me-2"></i>
                                        }
                                        @(IsNew ? "Create Invoice" : "Save Changes")
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
                        </div>
                    }
                </EditForm>
            }
        </div>
    </div>
</div>

<!-- Line Item Modal -->
@if (showLineItemModal && editingLineItem != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingLineItem.Id > 0 ? "Edit" : "Add") @(editingLineItem.Source == LineItemSource.Labor ? "Labor" : "Line Item")</h5>
                    <button type="button" class="btn-close" @onclick="CancelLineItemEdit"></button>
                </div>
                <div class="modal-body">
                    @if (editingLineItem.Source != LineItemSource.Labor)
                    {
                        <!-- Source Selection (only for non-labor items) -->
                        <div class="mb-3">
                            <label class="form-label">Item Source</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="itemSource" id="sourceCustom" 
                                       checked="@(editingLineItem.Source == LineItemSource.Custom)"
                                       @onchange="@(() => ChangeItemSource(LineItemSource.Custom))" />
                                <label class="btn btn-outline-primary" for="sourceCustom">
                                    <i class="bi bi-pencil-square me-1"></i>Custom Item
                                </label>
                                
                                <input type="radio" class="btn-check" name="itemSource" id="sourceInventory"
                                       checked="@(editingLineItem.Source == LineItemSource.Inventory)"
                                       @onchange="@(() => ChangeItemSource(LineItemSource.Inventory))" />
                                <label class="btn btn-outline-primary" for="sourceInventory">
                                    <i class="bi bi-box-seam me-1"></i>From Inventory
                                </label>
                            </div>
                        </div>

                        @if (editingLineItem.Source == LineItemSource.Inventory)
                        {
                            <!-- Inventory Item Selection -->
                            <div class="mb-3">
                                <label class="form-label">Select Inventory Item *</label>
                                <select class="form-select" @onchange="OnInventoryItemSelected">
                                    <option value="">-- Select Item --</option>
                                    @foreach (var item in inventoryItems)
                                    {
                                        <option value="@item.Id" selected="@(editingLineItem.SourceId == item.Id)">
                                            @item.Name (@item.QuantityOnHand @item.Unit available) - @item.Price.ToString("C")
                                        </option>
                                    }
                                </select>
                                <small class="text-muted">Items shown: Name (Stock) - Price</small>
                            </div>
                        }
                    }
                    else
                    {
                        <!-- Employee Selection for Labor -->
                        <div class="mb-3">
                            <label class="form-label">Employee (Optional)</label>
                            <select class="form-select" @onchange="OnEmployeeSelected">
                                <option value="">-- No Employee (Use Default Rate) --</option>
                                @foreach (var emp in employees)
                                {
                                    <option value="@emp.Id" selected="@(editingLineItem.SourceId == emp.Id)">
                                        @emp.DisplayName @(!SettingsStorage.GetBool("HideEmployeeRatesOnInvoice", false) ? $" - {emp.PayRate:C}/hr" : "")
                                    </option>
                                }
                            </select>
                            <small class="text-muted">Select an employee to auto-fill their hourly rate</small>
                        </div>
                    }

                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Description *</label>
                            <input type="text" class="form-control" @bind="editingLineItem.Description" 
                                   placeholder="@(editingLineItem.Source == LineItemSource.Labor ? "Labor description (e.g., Installation, Repairs)" : "Item description")" 
                                   disabled="@(editingLineItem.Source == LineItemSource.Inventory && editingLineItem.SourceId.HasValue)" />
                            @if (editingLineItem.Source == LineItemSource.Inventory && editingLineItem.SourceId.HasValue)
                            {
                                <small class="text-muted">Description is auto-filled from inventory</small>
                            }
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">@(editingLineItem.Source == LineItemSource.Labor ? "Hours" : "Quantity") *</label>
                            <input type="number" class="form-control" @bind="editingLineItem.Quantity" step="0.01" min="0" @oninput="UpdateLineItemTotal" />
                            @if (editingLineItem.Source == LineItemSource.Inventory && selectedInventoryItem != null)
                            {
                                <small class="text-muted">Available: @selectedInventoryItem.QuantityOnHand @selectedInventoryItem.Unit</small>
                            }
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">@(editingLineItem.Source == LineItemSource.Labor ? "Rate/Hour" : "Unit Price") *</label>
                            <input type="number" class="form-control" @bind="editingLineItem.UnitPrice" step="0.01" min="0" @oninput="UpdateLineItemTotal" />
                            @if (editingLineItem.Source == LineItemSource.Inventory && editingLineItem.SourceId.HasValue)
                            {
                                <small class="text-muted">Price from inventory (editable)</small>
                            }
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Total</label>
                            <input type="text" class="form-control bg-light fw-bold" value="@((editingLineItem.Quantity * editingLineItem.UnitPrice).ToString("C"))" disabled />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" rows="2" @bind="editingLineItem.Notes" placeholder="Optional notes"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelLineItemEdit">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveLineItem" disabled="@(string.IsNullOrWhiteSpace(editingLineItem.Description))">
                        <i class="bi bi-check-circle me-2"></i>Save @(editingLineItem.Source == LineItemSource.Labor ? "Labor" : "Item")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
[Parameter]
public int? Id { get; set; }

private bool IsNew => !Id.HasValue;
private bool isLoading = true;
private bool isSaving = false;
private bool isDirty = false;
private string errorMessage = "";
private Invoice model = new();
private EditContext? editContext;
private List<Customer> customers = new();
private List<InventoryItem> inventoryItems = new();
private List<Employee> employees = new();
private InventoryItem? selectedInventoryItem = null;
private Employee? selectedEmployee = null;
private List<InvoiceLineItem> lineItems = new();
private List<InvoiceLineItem> laborItems = new();
private InvoiceLineItem? editingLineItem = null;
private bool showLineItemModal = false;
private decimal defaultTaxRate = 7.0m; // Store global default for reference
private decimal defaultLaborRate = 75.0m;
private InvoicePricingType previousPricingType = InvoicePricingType.MaterialAndLabor;

private async Task OnBeforeInternalNavigation(Microsoft.AspNetCore.Components.Routing.LocationChangingContext context)
{
    if (isDirty && !isSaving)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "You have unsaved changes. Are you sure you want to leave this page?");
        if (!confirmed)
        {
            context.PreventNavigation();
        }
    }
}

private void OnFieldChanged(object? sender, FieldChangedEventArgs e) => isDirty = true;

    // Calculated properties
    private decimal CalculatedSubtotal => model.PricingType == InvoicePricingType.FlatRate 
        ? model.FlatRateAmount 
        : lineItems.Sum(i => i.Total) + laborItems.Sum(i => i.Total);
    private decimal CalculatedTaxAmount => model.TaxIncluded ? 0 : CalculatedSubtotal * (model.TaxRate / 100);
    private decimal CalculatedTotal => CalculatedSubtotal + CalculatedTaxAmount;

    private async Task OnPricingTypeChanged()
    {
        // Warn if switching to FlatRate when there are existing line items
        if (model.PricingType == InvoicePricingType.FlatRate && (lineItems.Any() || laborItems.Any()))
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                "Switching to Flat Rate will hide your itemized line items (they won't be used for the invoice total). Continue?");
            
            if (!confirmed)
            {
                // Revert to previous pricing type
                model.PricingType = previousPricingType;
                return;
            }
        }
        
        previousPricingType = model.PricingType;
        
        // Recalculate totals when pricing type changes
        RecalculateTotals();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomersAsync();
        await LoadInventoryAsync();
        await LoadEmployeesAsync();
        
        // Get default tax rate from settings
        defaultTaxRate = SettingsStorage.GetDecimal("DefaultTaxRate", 7.0m);
        defaultLaborRate = SettingsStorage.GetDecimal("DefaultLaborRate", 75.0m);
        var defaultPaymentDays = SettingsStorage.GetInt("DefaultPaymentTermsDays", 30);
        
        if (IsNew)
        {
            model = new Invoice
            {
                InvoiceNumber = $"INV-{DateTime.Now:yyyyMMddHHmmss}", // Temporary, regenerated on save
                Status = InvoiceStatus.Draft,
                InvoiceDate = DateTime.Today,
                DueDate = DateTime.Today.AddDays(defaultPaymentDays),
                TaxRate = defaultTaxRate,
                TaxIncluded = SettingsStorage.GetBool("TaxIncludedByDefault", false) // Use setting
            };
            isLoading = false;
        }
        else
        {
            await LoadInvoiceAsync();
        }

        // Initialize EditContext for dirty tracking
        editContext = new EditContext(model);
        editContext.OnFieldChanged += OnFieldChanged;
    }

    private async Task LoadCustomersAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        customers = await db.Customers
            .Where(c => c.Status == CustomerStatus.Active)
            .OrderBy(c => c.Name)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task LoadInventoryAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        inventoryItems = await db.InventoryItems
            .Where(i => i.QuantityOnHand > 0) // Only show in-stock items
            .OrderBy(i => i.Name)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task LoadEmployeesAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        employees = await db.Employees
            .Where(e => e.Status == EmployeeStatus.Active)
            .OrderBy(e => e.FirstName)
            .ThenBy(e => e.LastName)
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task LoadInvoiceAsync()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            var invoice = await db.Invoices
                .Include(i => i.LineItems)
                .FirstOrDefaultAsync(i => i.Id == Id!.Value);

            if (invoice != null)
            {
                // Create a new instance to avoid tracking issues
                model = new Invoice
                {
                    Id = invoice.Id,
                    InvoiceNumber = invoice.InvoiceNumber,
                    JobId = invoice.JobId,
                    EstimateId = invoice.EstimateId,
                    CustomerId = invoice.CustomerId,
                    Status = invoice.Status,
                    InvoiceDate = invoice.InvoiceDate,
                    DueDate = invoice.DueDate,
                    LaborAmount = invoice.LaborAmount,
                    PartsAmount = invoice.PartsAmount,
                    OtherAmount = invoice.OtherAmount,
                    DiscountAmount = invoice.DiscountAmount,
                    SubTotal = invoice.SubTotal,
                    TaxRate = invoice.TaxRate,
                    TaxAmount = invoice.TaxAmount,
                    TaxIncluded = invoice.TaxIncluded,
                    Total = invoice.Total,
                    AmountPaid = invoice.AmountPaid,
                    Notes = invoice.Notes,
                    Terms = invoice.Terms,
                    SentAt = invoice.SentAt,
                    PaidAt = invoice.PaidAt,
                    CreatedAt = invoice.CreatedAt,
                    IsDeleted = invoice.IsDeleted,
                    DeletedAt = invoice.DeletedAt,
                    DeletedBy = invoice.DeletedBy
                };
                
                previousPricingType = model.PricingType;
                
                var allItems = invoice.LineItems?.ToList() ?? new();
                
                // Separate parts and labor
                lineItems = allItems.Where(i => i.Source != LineItemSource.Labor).ToList();
                laborItems = allItems.Where(i => i.Source == LineItemSource.Labor).ToList();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load invoice: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        // Validate form before saving
        if (editContext != null && !editContext.Validate())
        {
            return;
        }

        // Additional validation for flat rate
        if (model.PricingType == InvoicePricingType.FlatRate && model.FlatRateAmount <= 0)
        {
            errorMessage = "Flat rate amount must be greater than zero.";
            return;
        }

        try
        {
            isSaving = true;
            errorMessage = "";

            await using var db = await DbFactory.CreateDbContextAsync();

            // Use calculated totals from line items
            model.SubTotal = CalculatedSubtotal;
            model.TaxAmount = CalculatedTaxAmount;
            model.Total = CalculatedTotal;

            if (IsNew)
            {
                // Generate invoice number
                var count = await db.Invoices.CountAsync() + 1;
                model.InvoiceNumber = $"INV-{count:D5}";
                
                model.CreatedAt = DateTime.UtcNow;
                db.Invoices.Add(model);
                await db.SaveChangesAsync(); // Save invoice first to get ID

                // Combine and add all line items
                var allItems = lineItems.Concat(laborItems).ToList();
                foreach (var item in allItems)
                {
                    item.InvoiceId = model.Id;
                    item.CreatedAt = DateTime.UtcNow;
                    db.InvoiceLineItems.Add(item);
                }
                await db.SaveChangesAsync();

                // Send notification email if not draft
                if (model.Status != InvoiceStatus.Draft)
                {
                    _ = NotificationService.SendInvoiceCreatedAsync(model);
                }

                // Auto-create employee time logs from labor items
                await TimeLogAutoService.CreateTimeLogsFromInvoiceAsync(model.Id);
            }
            else
            {
                db.Invoices.Update(model);
                
                // Combine all items
                var allItems = lineItems.Concat(laborItems).ToList();
                
                // Delete removed line items
                var existingIds = allItems.Where(i => i.Id > 0).Select(i => i.Id).ToList();
                var toDelete = await db.InvoiceLineItems
                    .Where(i => i.InvoiceId == model.Id && !existingIds.Contains(i.Id))
                    .ToListAsync();
                db.InvoiceLineItems.RemoveRange(toDelete);

                // Update/add line items
                foreach (var item in allItems)
                {
                    item.InvoiceId = model.Id;
                    if (item.Id > 0)
                    {
                        db.InvoiceLineItems.Update(item);
                    }
                    else
                    {
                        item.CreatedAt = DateTime.UtcNow;
                        db.InvoiceLineItems.Add(item);
                    }
                }
                
                await db.SaveChangesAsync();

                // Update employee time logs
                await TimeLogAutoService.UpdateTimeLogsFromInvoiceAsync(model.Id);
            }

            // Reset dirty flag before navigation
            isDirty = false;

            Navigation.NavigateTo(IsNew ? "/invoices" : $"/invoices/{model.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task SoftDeleteInvoice()
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Delete this invoice? You can restore it later from the deleted invoices view."))
            return;

        try
        {
            isSaving = true;

            await using var db = await DbFactory.CreateDbContextAsync();
            
            var invoice = await db.Invoices.FirstOrDefaultAsync(i => i.Id == model.Id);
            if (invoice != null)
            {
                invoice.IsDeleted = true;
                invoice.DeletedAt = DateTime.UtcNow;
                invoice.DeletedBy = "Web User"; // TODO: Get from authentication
                
                await db.SaveChangesAsync();
            }

            Navigation.NavigateTo("/invoices");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete: {ex.Message}";
            isSaving = false;
        }
    }

    private async Task RestoreInvoice()
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Restore this invoice?"))
            return;

        try
        {
            isSaving = true;

            await using var db = await DbFactory.CreateDbContextAsync();
            
            var invoice = await db.Invoices.FirstOrDefaultAsync(i => i.Id == model.Id);
            if (invoice != null)
            {
                invoice.IsDeleted = false;
                invoice.DeletedAt = null;
                invoice.DeletedBy = null;
                
                await db.SaveChangesAsync();
            }

            // Reload the page to show updated state
            Navigation.NavigateTo($"/invoices/{model.Id}/edit", forceLoad: true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to restore: {ex.Message}";
            isSaving = false;
        }
    }

    private async Task HardDeleteInvoice()
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "PERMANENTLY delete this invoice? This CANNOT be undone!"))
            return;

        try
        {
            isSaving = true;

            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Load invoice with line items
            var invoice = await db.Invoices
                .Include(i => i.LineItems)
                .FirstOrDefaultAsync(i => i.Id == model.Id);

            if (invoice != null)
            {
                // Delete line items first
                if (invoice.LineItems != null && invoice.LineItems.Any())
                {
                    db.InvoiceLineItems.RemoveRange(invoice.LineItems);
                }

                // Delete invoice permanently
                db.Invoices.Remove(invoice);
                await db.SaveChangesAsync();
            }

            Navigation.NavigateTo("/invoices");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to permanently delete: {ex.Message}";
            isSaving = false;
        }
    }

    private void Cancel()
    {
        if (IsNew)
            Navigation.NavigateTo("/invoices");
        else
            Navigation.NavigateTo($"/invoices/{Id}");
    }

    // Line Item Management
    private void AddLineItem()
    {
        editingLineItem = new InvoiceLineItem
        {
            Quantity = 1,
            UnitPrice = 0,
            Source = LineItemSource.Custom
        };
        showLineItemModal = true;
    }

    private void EditLineItem(InvoiceLineItem item)
    {
        editingLineItem = item;
        showLineItemModal = true;
    }

    private void DeleteLineItem(InvoiceLineItem item)
    {
        lineItems.Remove(item);
        StateHasChanged(); // Trigger recalculation
    }

    // Labor Item Management
    private void AddLaborItem()
    {
        editingLineItem = new InvoiceLineItem
        {
            Quantity = 1,
            UnitPrice = defaultLaborRate, // Use default from settings
            Source = LineItemSource.Labor
        };
        showLineItemModal = true;
    }

    private void EditLaborItem(InvoiceLineItem item)
    {
        editingLineItem = item;
        showLineItemModal = true;
    }

    private void DeleteLaborItem(InvoiceLineItem item)
    {
        laborItems.Remove(item);
        StateHasChanged(); // Trigger recalculation
    }

    private void SaveLineItem()
    {
        if (editingLineItem == null) return;

        // Add to appropriate list if new
        if (editingLineItem.Source == LineItemSource.Labor)
        {
            if (!laborItems.Contains(editingLineItem))
            {
                laborItems.Add(editingLineItem);
            }
        }
        else
        {
            if (!lineItems.Contains(editingLineItem))
            {
                lineItems.Add(editingLineItem);
            }
        }

        CancelLineItemEdit();
        StateHasChanged(); // Trigger recalculation
    }

    private void UpdateLineItemTotal()
    {
        // This is called on input to trigger a re-render showing the updated total
        StateHasChanged();
    }

    private void RecalculateTotals()
    {
        StateHasChanged(); // Recalculate displayed totals
    }

    private void ResetToGlobalTaxRate()
    {
        model.TaxRate = defaultTaxRate;
        StateHasChanged();
    }

    private void ChangeItemSource(string newSource)
    {
        if (editingLineItem == null) return;
        
        editingLineItem.Source = newSource;
        
        // Clear inventory-specific fields when switching to custom
        if (newSource == LineItemSource.Custom)
        {
            editingLineItem.SourceId = null;
            selectedInventoryItem = null;
        }
        
        StateHasChanged();
    }

    private void OnInventoryItemSelected(ChangeEventArgs e)
    {
        if (editingLineItem == null || string.IsNullOrEmpty(e.Value?.ToString())) return;
        
        var itemId = int.Parse(e.Value.ToString()!);
        selectedInventoryItem = inventoryItems.FirstOrDefault(i => i.Id == itemId);
        
        if (selectedInventoryItem != null)
        {
            editingLineItem.SourceId = selectedInventoryItem.Id;
            editingLineItem.Description = selectedInventoryItem.Name;
            editingLineItem.UnitPrice = selectedInventoryItem.Price;
            editingLineItem.Quantity = 1; // Default quantity
            
            StateHasChanged();
        }
    }

    private void OnEmployeeSelected(ChangeEventArgs e)
    {
        if (editingLineItem == null) return;
        
        if (string.IsNullOrEmpty(e.Value?.ToString()))
        {
            // No employee selected - use default
            editingLineItem.SourceId = null;
            editingLineItem.UnitPrice = defaultLaborRate;
            selectedEmployee = null;
        }
        else
        {
            var empId = int.Parse(e.Value.ToString()!);
            selectedEmployee = employees.FirstOrDefault(emp => emp.Id == empId);
            
            if (selectedEmployee != null)
            {
                editingLineItem.SourceId = selectedEmployee.Id;
                editingLineItem.UnitPrice = selectedEmployee.PayRate;
            }
        }
        
        StateHasChanged();
    }

    private void CancelLineItemEdit()
    {
        showLineItemModal = false;
        editingLineItem = null;
        selectedInventoryItem = null;
        selectedEmployee = null;
    }

    public void Dispose()
    {
        if (editContext != null)
        {
            editContext.OnFieldChanged -= OnFieldChanged;
        }
    }
}




