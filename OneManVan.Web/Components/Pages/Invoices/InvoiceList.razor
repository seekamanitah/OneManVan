@page "/invoices"
@using Microsoft.EntityFrameworkCore
@using OneManVan.Shared.Data
@using OneManVan.Shared.Models
@using OneManVan.Shared.Models.Enums

@inject IDbContextFactory<OneManVanDbContext> DbFactory
@inject NavigationManager Navigation

<PageTitle>Invoices - OneManVan</PageTitle>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">Invoices</h1>
            <p class="text-muted mb-0">Customer billing and payments</p>
        </div>
        <div class="d-flex gap-2">
            <ImportButton EntityType="invoices" EntityDisplayName="Invoices" DuplicateField="InvoiceNumber" OnImportComplete="OnImportComplete" />
            <ExportButton EntityType="invoices" />
            <button class="btn btn-primary" @onclick="CreateInvoice">
                <i class="bi bi-plus-circle me-2"></i>New Invoice
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block">Total Outstanding</small>
                    <h3 class="mb-0">@totalOutstanding.ToString("C")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block">Overdue</small>
                    <h3 class="mb-0 text-danger">@overdueCount</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block">Paid This Month</small>
                    <h3 class="mb-0 text-success">@paidThisMonth.ToString("C")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block">Draft</small>
                    <h3 class="mb-0">@draftCount</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0" 
                               placeholder="Search invoices..." 
                               @bind="searchText" @bind:event="oninput" @onkeyup="OnSearchChanged" />
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="filterStatus" @bind:after="ApplyFilters">
                        <option value="">All Statuses</option>
                        @foreach (var s in Enum.GetValues<InvoiceStatus>())
                        {
                            <option value="@s">@s</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn @(showDeleted ? "btn-primary" : "btn-outline-secondary")" @onclick="ToggleShowDeleted">
                        <i class="bi bi-@(showDeleted ? "eye-slash" : "eye") me-2"></i>@(showDeleted ? "Hide" : "Show") Deleted
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice List -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            }
            else if (filteredInvoices.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Invoice #</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Due Date</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Balance</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in filteredInvoices)
                            {
                                <tr class="@(invoice.IsDeleted ? "table-secondary" : "")" style="cursor: pointer;" @onclick="@(() => ViewInvoice(invoice.Id))">
                                    <td>
                                        <span class="fw-semibold">@invoice.InvoiceNumber</span>
                                        @if (invoice.IsDeleted)
                                        {
                                            <span class="badge bg-warning text-dark ms-2">Deleted</span>
                                        }
                                    </td>
                                    <td>@(invoice.Customer?.Name ?? "-")</td>
                                    <td>@invoice.InvoiceDate.ToString("MMM dd, yyyy")</td>
                                    <td class="@(invoice.IsOverdue ? "text-danger" : "")">
                                        @invoice.DueDate.ToString("MMM dd, yyyy")
                                    </td>
                                    <td class="text-end">@invoice.Total.ToString("C")</td>
                                    <td class="text-end @(invoice.BalanceDue > 0 ? "text-warning fw-semibold" : "text-success")">
                                        @invoice.BalanceDue.ToString("C")
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadge(invoice.Status)">@invoice.Status</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" @onclick:stopPropagation="true">
                                            @if (invoice.IsDeleted)
                                            {
                                                <button class="btn btn-outline-success" title="Restore" @onclick="@(() => RestoreInvoice(invoice))">
                                                    <i class="bi bi-arrow-counterclockwise"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" title="Delete Permanently" @onclick="@(() => ShowPermanentDeleteConfirmation(invoice))">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-outline-primary" @onclick="@(() => ViewInvoice(invoice.Id))">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" @onclick="@(() => EditInvoice(invoice.Id))">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" title="Delete" @onclick="@(() => ShowDeleteConfirmation(invoice))">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-receipt fs-1 text-muted mb-3 d-block"></i>
                    <h5>No invoices found</h5>
                    <button class="btn btn-primary" @onclick="CreateInvoice">
                        <i class="bi bi-plus-circle me-2"></i>New Invoice
                    </button>
                </div>
            }
        </div>
    </div>
</div>

<DeleteConfirmationModal 
    IsVisible="showDeleteModal"
    EntityType="invoice"
    EntityName="@(invoiceToDelete?.InvoiceNumber)"
    AdditionalWarning="Payment records may be affected."
    OnConfirm="DeleteInvoice"
    OnCancel="CancelDelete" />

<DeleteConfirmationModal 
    IsVisible="showPermanentDeleteModal"
    EntityType="invoice"
    EntityName="@(invoiceToPermanentlyDelete?.InvoiceNumber)"
    AdditionalWarning="This will permanently delete the invoice and cannot be undone."
    OnConfirm="PermanentlyDeleteInvoice"
    OnCancel="CancelPermanentDelete" />

@code {
private bool isLoading = true;
private List<Invoice> allInvoices = new();
private List<Invoice> filteredInvoices = new();
    
private string searchText = "";
private string filterStatus = "";
private bool showDeleted = false;
    
private decimal totalOutstanding = 0;
private int overdueCount = 0;
private decimal paidThisMonth = 0;
private int draftCount = 0;
    
private bool showDeleteModal = false;
private Invoice? invoiceToDelete;

protected override async Task OnInitializedAsync()
{
    await LoadInvoicesAsync();
}

private async Task LoadInvoicesAsync()
{
    try
    {
        isLoading = true;

        await using var db = await DbFactory.CreateDbContextAsync();
            
        var query = db.Invoices
            .Include(i => i.Customer)
            .AsQueryable();

        // Filter deleted invoices unless showing them
        if (!showDeleted)
        {
            query = query.Where(i => !i.IsDeleted);
        }

        allInvoices = await query
            .OrderByDescending(i => i.InvoiceDate)
            .AsNoTracking()
            .ToListAsync();

        // Calculate stats (only for non-deleted)
        var activeInvoices = allInvoices.Where(i => !i.IsDeleted).ToList();
        totalOutstanding = activeInvoices.Sum(i => i.BalanceDue);
        overdueCount = activeInvoices.Count(i => i.IsOverdue);
        draftCount = activeInvoices.Count(i => i.Status == InvoiceStatus.Draft);
            
            var startOfMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            paidThisMonth = allInvoices
                .Where(i => i.PaidAt >= startOfMonth)
                .Sum(i => i.AmountPaid);

            ApplyFilters();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        var query = allInvoices.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var search = searchText.ToLower();
            query = query.Where(i =>
                i.InvoiceNumber.ToLower().Contains(search) ||
                (i.Customer?.Name?.ToLower().Contains(search) ?? false));
        }

        if (!string.IsNullOrWhiteSpace(filterStatus) && Enum.TryParse<InvoiceStatus>(filterStatus, out var status))
        {
            query = query.Where(i => i.Status == status);
        }

        filteredInvoices = query.ToList();
    }

    private void OnSearchChanged(KeyboardEventArgs e) => ApplyFilters();

    private async Task ToggleShowDeleted()
    {
        showDeleted = !showDeleted;
        await LoadInvoicesAsync();
    }

    private void CreateInvoice() => Navigation.NavigateTo("/invoices/new");
    private void ViewInvoice(int id) => Navigation.NavigateTo($"/invoices/{id}");
    private void EditInvoice(int id) => Navigation.NavigateTo($"/invoices/{id}/edit");

    private string GetStatusBadge(InvoiceStatus status) => status switch
    {
        InvoiceStatus.Draft => "bg-secondary",
        InvoiceStatus.Sent => "bg-info",
        InvoiceStatus.PartiallyPaid => "bg-warning",
        InvoiceStatus.Paid => "bg-success",
        InvoiceStatus.Overdue => "bg-danger",
        InvoiceStatus.Cancelled => "bg-dark",
        _ => "bg-secondary"
    };

    private async Task OnImportComplete()
    {
        await LoadInvoicesAsync();
    }

    private void ShowDeleteConfirmation(Invoice invoice)
    {
        invoiceToDelete = invoice;
        showDeleteModal = true;
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        invoiceToDelete = null;
    }

    private async Task DeleteInvoice()
    {
        if (invoiceToDelete == null) return;
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var invoice = await db.Invoices.FindAsync(invoiceToDelete.Id);
            if (invoice != null)
            {
                // Soft delete - mark as deleted instead of removing
                invoice.IsDeleted = true;
                invoice.DeletedAt = DateTime.UtcNow;
                await db.SaveChangesAsync();
            }
            
            showDeleteModal = false;
            invoiceToDelete = null;
            await LoadInvoicesAsync();
        }
        catch
        {
            showDeleteModal = false;
            invoiceToDelete = null;
        }
    }

    private async Task RestoreInvoice(Invoice invoice)
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var dbInvoice = await db.Invoices.FindAsync(invoice.Id);
            if (dbInvoice != null)
            {
                dbInvoice.IsDeleted = false;
                dbInvoice.DeletedAt = null;
                dbInvoice.DeletedBy = null;
                await db.SaveChangesAsync();
            }
            await LoadInvoicesAsync();
        }
        catch
        {
            // Could show error toast
        }
    }

    private bool showPermanentDeleteModal = false;
    private Invoice? invoiceToPermanentlyDelete;

    private void ShowPermanentDeleteConfirmation(Invoice invoice)
    {
        invoiceToPermanentlyDelete = invoice;
        showPermanentDeleteModal = true;
    }

    private void CancelPermanentDelete()
    {
        showPermanentDeleteModal = false;
        invoiceToPermanentlyDelete = null;
    }

    private async Task PermanentlyDeleteInvoice()
    {
        if (invoiceToPermanentlyDelete == null) return;
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var invoice = await db.Invoices.FindAsync(invoiceToPermanentlyDelete.Id);
            if (invoice != null)
            {
                db.Invoices.Remove(invoice);
                await db.SaveChangesAsync();
            }
            
            showPermanentDeleteModal = false;
            invoiceToPermanentlyDelete = null;
            await LoadInvoicesAsync();
        }
        catch
        {
            showPermanentDeleteModal = false;
            invoiceToPermanentlyDelete = null;
        }
    }
}
