<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="OneManVan.Mobile.Pages.EditEstimatePage"
             Title="Edit Estimate"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">

    <Grid RowDefinitions="*, Auto">
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="16" Spacing="16">

                <!-- Status Banner -->
                <Border x:Name="StatusBanner"
                        BackgroundColor="{StaticResource Primary}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Grid ColumnDefinitions="Auto, *">
                        <Label x:Name="StatusIcon" Text="?" FontSize="24" VerticalOptions="Center"/>
                        <VerticalStackLayout Grid.Column="1" Margin="12,0,0,0" VerticalOptions="Center">
                            <Label x:Name="StatusText" Text="Draft" FontSize="18" FontAttributes="Bold" TextColor="White"/>
                            <Label x:Name="StatusSubtext" Text="Tap to change status" FontSize="12" TextColor="White" Opacity="0.8"/>
                        </VerticalStackLayout>
                    </Grid>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnStatusTapped"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- Customer (Read-only for existing estimates) -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Customer" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                        <Label x:Name="CustomerNameLabel" 
                               Text="Customer Name" 
                               FontSize="16" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Estimate Details -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Estimate Details" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"/>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="Title *" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}" FontAttributes="Bold"/>
                            <Entry x:Name="TitleEntry" 
                                   Placeholder="Estimate title"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="Description" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            <Editor x:Name="DescriptionEditor"
                                    Placeholder="Detailed description..."
                                    HeightRequest="100"/>
                        </VerticalStackLayout>

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Valid Until" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                                <DatePicker x:Name="ExpiresDatePicker"/>
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label Text="Tax Rate (%)" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                                <Entry x:Name="TaxRateEntry" 
                                       Keyboard="Numeric"
                                       TextChanged="OnTaxRateChanged"/>
                            </VerticalStackLayout>
                        </Grid>

                        <!-- Tax Included Toggle -->
                        <HorizontalStackLayout Spacing="8">
                            <Switch x:Name="TaxIncludedSwitch" 
                                    OnColor="{StaticResource Primary}"
                                    ThumbColor="White"
                                    Toggled="OnTaxIncludedToggled"/>
                            <Label Text="Tax Already Included in Price" 
                                   FontSize="14" 
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Line Items -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="12">
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Line Items" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"
                                   VerticalOptions="Center"/>
                            <Button Grid.Column="1"
                                    x:Name="AddLineButton"
                                    Text="+ Add Item"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource PrimarySurface}, Dark={StaticResource Gray600}}"
                                    TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"
                                    FontSize="12"
                                    HeightRequest="36"
                                    CornerRadius="8"
                                    Clicked="OnAddLineItemClicked"/>
                        </Grid>

                        <CollectionView x:Name="LineItemsCollection"
                                        SelectionMode="None">
                            <CollectionView.EmptyView>
                                <Label Text="No line items. Tap '+ Add Item' to add."
                                       TextColor="{AppThemeBinding Light={StaticResource LightTextTertiary}, Dark={StaticResource DarkTextTertiary}}"
                                       FontSize="14"
                                       HorizontalTextAlignment="Center"
                                       Margin="0,20"/>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems Mode="Reveal">
                                                <SwipeItem Text="Delete"
                                                           BackgroundColor="{StaticResource Error}"
                                                           Invoked="OnDeleteLineItem"/>
                                            </SwipeItems>
                                        </SwipeView.RightItems>
                                        <Border Margin="0,4" 
                                                Padding="12"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource LightInputBackground}, Dark={StaticResource DarkInputBackground}}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnLineItemTapped"/>
                                            </Border.GestureRecognizers>
                                            <Grid ColumnDefinitions="Auto, *, Auto" ColumnSpacing="12">
                                                <Border WidthRequest="40" 
                                                        HeightRequest="40"
                                                        StrokeShape="RoundRectangle 20"
                                                        BackgroundColor="{Binding TypeColor}"
                                                        Stroke="Transparent">
                                                    <Label Text="{Binding TypeIcon}"
                                                           FontSize="16"
                                                           HorizontalOptions="Center"
                                                           VerticalOptions="Center"/>
                                                </Border>
                                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                                    <Label Text="{Binding Description}"
                                                           FontSize="14"
                                                           FontAttributes="Bold"
                                                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"
                                                           LineBreakMode="TailTruncation"/>
                                                    <Label FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}">
                                                        <Label.FormattedText>
                                                            <FormattedString>
                                                                <Span Text="{Binding Quantity, StringFormat='{0:F0}'}"/>
                                                                <Span Text=" x $"/>
                                                                <Span Text="{Binding UnitPrice, StringFormat='{0:F2}'}"/>
                                                            </FormattedString>
                                                        </Label.FormattedText>
                                                    </Label>
                                                </VerticalStackLayout>
                                                <Label Grid.Column="2" 
                                                       Text="{Binding Total, StringFormat='${0:F2}'}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource Success}"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Border>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Totals -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="8">
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Subtotal" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            <Label x:Name="SubtotalLabel" Grid.Column="1" Text="$0.00" TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                        </Grid>
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Tax" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            <Label x:Name="TaxAmountLabel" Grid.Column="1" Text="$0.00" TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                        </Grid>
                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"/>
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Total" FontSize="18" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                            <Label x:Name="TotalLabel" Grid.Column="1" Text="$0.00" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource Success}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- Notes and Terms -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Notes and Terms" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"/>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="Internal Notes" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            <Editor x:Name="NotesEditor"
                                    Placeholder="Internal notes..."
                                    HeightRequest="60"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="Terms and Conditions" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            <Editor x:Name="TermsEditor"
                                    Placeholder="Payment terms, warranty..."
                                    HeightRequest="80"/>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Quick Actions -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Quick Actions" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"/>

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <Button x:Name="SendButton"
                                    Text="Send to Customer"
                                    BackgroundColor="{StaticResource Success}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    HeightRequest="44"
                                    Clicked="OnSendClicked"/>
                            <Button x:Name="ConvertButton"
                                    Grid.Column="1"
                                    Text="Convert to Job"
                                    BackgroundColor="{StaticResource Warning}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    HeightRequest="44"
                                    Clicked="OnConvertToJobClicked"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- Delete -->
                <Button x:Name="DeleteButton"
                        Text="Delete Estimate"
                        BackgroundColor="{StaticResource ErrorSurface}"
                        TextColor="{StaticResource Error}"
                        CornerRadius="8"
                        HeightRequest="44"
                        Clicked="OnDeleteClicked"/>

                <BoxView HeightRequest="16"/>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Bottom Save Bar -->
        <Border Grid.Row="1" 
                BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                Padding="16"
                StrokeShape="RoundRectangle 0"
                Stroke="Transparent">
            <Border.Shadow>
                <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,-2" Radius="4" Opacity="0.1"/>
            </Border.Shadow>
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                <Button Text="Cancel"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                        TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"
                        CornerRadius="8"
                        HeightRequest="50"
                        Clicked="OnCancelClicked"/>
                <Button Grid.Column="1"
                        Text="Save Changes"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        HeightRequest="50"
                        Clicked="OnSaveClicked"/>
            </Grid>
        </Border>
    </Grid>

</ContentPage>
