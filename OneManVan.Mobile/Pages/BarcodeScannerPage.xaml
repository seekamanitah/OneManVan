<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:zxing="clr-namespace:ZXing.Net.Maui.Controls;assembly=ZXing.Net.Maui.Controls"
             x:Class="OneManVan.Mobile.Pages.BarcodeScannerPage"
             Title="Scan Barcode"
             BackgroundColor="#000000"
             Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="Auto, *, Auto, Auto">

        <!-- Header -->
        <Border Grid.Row="0" BackgroundColor="#1976D2" 
                Padding="15" StrokeShape="RoundRectangle 0" Stroke="Transparent">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <Button Text="X" Clicked="OnCancelClicked"
                        BackgroundColor="Transparent" TextColor="White"
                        FontSize="20" WidthRequest="44" HeightRequest="44"/>
                
                <StackLayout Grid.Column="1" VerticalOptions="Center">
                    <Label x:Name="TitleLabel" Text="Scan Barcode" 
                           FontSize="18" FontAttributes="Bold" 
                           TextColor="White" HorizontalOptions="Center"/>
                    <Label x:Name="SubtitleLabel" Text="Point camera at barcode" 
                           FontSize="12" TextColor="#FFFFFFAA" 
                           HorizontalOptions="Center"/>
                </StackLayout>
                
                <Button x:Name="FlashButton" Text="Flash" Clicked="OnFlashToggle"
                        Grid.Column="2"
                        BackgroundColor="Transparent" TextColor="White"
                        FontSize="14" WidthRequest="70" HeightRequest="44"/>
            </Grid>
        </Border>

        <!-- Camera Preview Area with ZXing -->
        <Grid Grid.Row="1" BackgroundColor="#1A1A1A">
            <!-- ZXing Camera Barcode Reader -->
            <zxing:CameraBarcodeReaderView 
                x:Name="BarcodeReader"
                IsDetecting="True"
                IsTorchOn="{Binding IsTorchOn}"
                BarcodesDetected="OnBarcodesDetected"
                HorizontalOptions="FillAndExpand"
                VerticalOptions="FillAndExpand"/>
            
            <!-- Scan Frame Overlay -->
            <Border x:Name="ScanFrame" 
                    BackgroundColor="Transparent" 
                    Stroke="#4CAF50"
                    StrokeThickness="3"
                    StrokeShape="RoundRectangle 12"
                    WidthRequest="280" HeightRequest="200"
                    HorizontalOptions="Center" VerticalOptions="Center">
                <Grid>
                    <BoxView x:Name="ScanLine" BackgroundColor="#4CAF5080" 
                             HeightRequest="2" VerticalOptions="Start" Margin="10"/>
                </Grid>
            </Border>

            <StackLayout VerticalOptions="End" Margin="20,0,20,30">
                <Label Text="Position the barcode within the frame"
                       TextColor="White" FontSize="14"
                       HorizontalOptions="Center" Opacity="0.8"/>
            </StackLayout>
        </Grid>

        <!-- Recent Scans Preview -->
        <Border Grid.Row="2" BackgroundColor="#2A2A2A" 
                Padding="15" StrokeShape="RoundRectangle 0" Stroke="Transparent"
                x:Name="RecentScansFrame" IsVisible="False">
            <StackLayout Spacing="8">
                <Label Text="Recent Scan" FontSize="12" TextColor="#888"/>
                <Grid ColumnDefinitions="*, Auto">
                    <Label x:Name="LastScanLabel" Text="" 
                           FontSize="16" FontAttributes="Bold" 
                           TextColor="White" LineBreakMode="TailTruncation"/>
                    <Button Grid.Column="1" Text="Use" 
                            BackgroundColor="#4CAF50" TextColor="White"
                            Padding="15,8" CornerRadius="6"
                            Clicked="OnUseLastScanClicked"/>
                </Grid>
            </StackLayout>
        </Border>

        <!-- Manual Entry Option -->
        <Border Grid.Row="3" BackgroundColor="#1A1A1A" 
                Padding="15" StrokeShape="RoundRectangle 0" Stroke="Transparent">
            <StackLayout Spacing="12">
                <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10">
                    <Entry x:Name="ManualEntry" Placeholder="Enter barcode manually..."
                           BackgroundColor="#333" TextColor="White"
                           PlaceholderColor="#666" FontSize="16"
                           ReturnType="Done" Completed="OnManualEntryCompleted"/>
                    <Button Text="OK" Clicked="OnManualSubmitClicked"
                            Grid.Column="1"
                            BackgroundColor="#1976D2" TextColor="White"
                            WidthRequest="50" HeightRequest="50"
                            CornerRadius="25"/>
                </Grid>
                
                <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="Format:" TextColor="#888" VerticalOptions="Center" FontSize="12"/>
                        <Button x:Name="FormatAllBtn" Text="All" 
                                BackgroundColor="#4CAF50" TextColor="White"
                                Padding="12,6" CornerRadius="12" FontSize="11"
                                Clicked="OnFormatSelected"/>
                        <Button x:Name="FormatQRBtn" Text="QR Code" 
                                BackgroundColor="#444" TextColor="White"
                                Padding="12,6" CornerRadius="12" FontSize="11"
                                Clicked="OnFormatSelected"/>
                        <Button x:Name="Format1DBtn" Text="1D Barcode" 
                                BackgroundColor="#444" TextColor="White"
                                Padding="12,6" CornerRadius="12" FontSize="11"
                                Clicked="OnFormatSelected"/>
                    </HorizontalStackLayout>
                </ScrollView>
            </StackLayout>
        </Border>

        <!-- Loading Overlay -->
        <Grid x:Name="LoadingOverlay" Grid.RowSpan="4" 
              BackgroundColor="#CC000000" IsVisible="False">
            <StackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="15">
                <ActivityIndicator IsRunning="True" Color="#4CAF50" Scale="1.5"/>
                <Label Text="Processing..." TextColor="White" FontSize="16"/>
            </StackLayout>
        </Grid>
    </Grid>
</ContentPage>
