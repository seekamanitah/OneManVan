<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="OneManVan.Mobile.Pages.AddInvoicePage"
             Title="New Invoice"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">

    <Grid RowDefinitions="*, Auto">
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="16" Spacing="16">

                <!-- Customer Selection -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Customer *" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}" FontAttributes="Bold"/>
                        <Border x:Name="CustomerSelector"
                                BackgroundColor="{AppThemeBinding Light={StaticResource LightInputBackground}, Dark={StaticResource DarkInputBackground}}"
                                StrokeShape="RoundRectangle 8"
                                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                Padding="12">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSelectCustomerTapped"/>
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="*, Auto">
                                <Label x:Name="CustomerNameLabel" 
                                       Text="Tap to select customer..."
                                       TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                                       FontSize="16"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="1" 
                                       Text=">" 
                                       TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Border>
                        
                        <!-- Billing Info -->
                        <Border x:Name="BillingInfoPanel"
                                BackgroundColor="{AppThemeBinding Light={StaticResource PrimarySurface}, Dark={StaticResource Gray600}}"
                                StrokeShape="RoundRectangle 8"
                                Stroke="Transparent"
                                Padding="12"
                                IsVisible="False">
                            <VerticalStackLayout Spacing="4">
                                <Label x:Name="CustomerEmailLabel" 
                                       FontSize="12" 
                                       TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"/>
                                <Label x:Name="PaymentTermsLabel" 
                                       FontSize="12" 
                                       TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"/>
                            </VerticalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </Border>

                <!-- Invoice Details -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Invoice Details" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"/>

                        <!-- Title/Description -->
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Invoice Title *" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}" FontAttributes="Bold"/>
                            <Entry x:Name="TitleEntry" 
                                   Placeholder="e.g., AC Repair - Service Call"
                                   FontSize="16"/>
                        </VerticalStackLayout>

                        <!-- Invoice Date and Due Date -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Invoice Date" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                                <DatePicker x:Name="InvoiceDatePicker"/>
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label Text="Due Date" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                                <DatePicker x:Name="DueDatePicker"/>
                            </VerticalStackLayout>
                        </Grid>

                        <!-- Status -->
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Status" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            <Picker x:Name="StatusPicker" Title="Select Status">
                                <Picker.ItemsSource>
                                    <x:Array Type="{x:Type x:String}">
                                        <x:String>Draft</x:String>
                                        <x:String>Sent</x:String>
                                    </x:Array>
                                </Picker.ItemsSource>
                            </Picker>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Line Items -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="12">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Line Items" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"/>
                            <Button Grid.Column="1"
                                    Text="+ Add"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource PrimarySurface}, Dark={StaticResource Gray600}}"
                                    TextColor="{StaticResource Primary}"
                                    FontSize="12"
                                    HeightRequest="32"
                                    CornerRadius="16"
                                    Padding="12,0"
                                    Clicked="OnAddLineItemClicked"/>
                        </Grid>

                        <CollectionView x:Name="LineItemsCollection"
                                        EmptyView="No items added. Tap + Add to add line items.">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,4" 
                                            Padding="12"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource LightInputBackground}, Dark={StaticResource DarkInputBackground}}"
                                            StrokeShape="RoundRectangle 8"
                                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}">
                                        <Grid ColumnDefinitions="*, Auto, Auto" ColumnSpacing="8">
                                            <VerticalStackLayout>
                                                <Label Text="{Binding Description}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"
                                                       LineBreakMode="TailTruncation"/>
                                                <Label FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="{Binding Quantity, StringFormat='{0} x '}"/>
                                                            <Span Text="{Binding UnitPrice, StringFormat='${0:N2}'}"/>
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                            </VerticalStackLayout>
                                            <Label Grid.Column="1"
                                                   Text="{Binding Total, StringFormat='${0:N2}'}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Primary}"
                                                   VerticalOptions="Center"/>
                                            <Button Grid.Column="2"
                                                    Text="X"
                                                    BackgroundColor="Transparent"
                                                    TextColor="{StaticResource Error}"
                                                    FontSize="14"
                                                    WidthRequest="32"
                                                    HeightRequest="32"
                                                    Clicked="OnRemoveLineItemClicked"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Totals -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="8">
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Subtotal" FontSize="14" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            <Label x:Name="SubtotalLabel" 
                                   Grid.Column="1" 
                                   Text="$0.00" 
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                        </Grid>
                        
                        <Grid ColumnDefinitions="*, Auto, Auto" ColumnSpacing="8">
                            <Label Text="Tax Rate (%)" FontSize="14" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}" VerticalOptions="Center"/>
                            <Entry x:Name="TaxRateEntry"
                                   Grid.Column="1"
                                   Text="8"
                                   Keyboard="Numeric"
                                   WidthRequest="60"
                                   TextChanged="OnTaxRateChanged"/>
                            <Label x:Name="TaxAmountLabel" 
                                   Grid.Column="2" 
                                   Text="$0.00" 
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"
                                   VerticalOptions="Center"/>
                        </Grid>

                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"/>

                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Total" FontSize="18" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                            <Label x:Name="TotalLabel" 
                                   Grid.Column="1" 
                                   Text="$0.00" 
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- Notes -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                        StrokeShape="RoundRectangle 12" 
                        Stroke="Transparent"
                        Padding="16">
                    <Border.Shadow>
                        <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,2" Radius="4" Opacity="0.1"/>
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Notes (visible on invoice)" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                        <Editor x:Name="NotesEditor"
                                Placeholder="Payment instructions, thank you message, etc."
                                HeightRequest="60"
                                FontSize="14"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Spacer -->
                <BoxView HeightRequest="16"/>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Fixed Bottom Action Buttons -->
        <Border Grid.Row="1" 
                BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}" 
                Padding="16"
                StrokeShape="RoundRectangle 0"
                Stroke="Transparent">
            <Border.Shadow>
                <Shadow Brush="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}" Offset="0,-2" Radius="4" Opacity="0.1"/>
            </Border.Shadow>
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                <Button Grid.Column="0"
                        Text="Cancel"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                        TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"
                        CornerRadius="8"
                        HeightRequest="50"
                        Clicked="OnCancelClicked"/>
                <Button Grid.Column="1"
                        Text="Create Invoice"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        HeightRequest="50"
                        Clicked="OnSaveClicked"/>
            </Grid>
        </Border>
    </Grid>

</ContentPage>
