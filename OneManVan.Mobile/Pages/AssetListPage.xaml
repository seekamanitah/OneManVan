<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="OneManVan.Mobile.Pages.AssetListPage"
             Title="Assets"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Search Bar -->
        <SearchBar Grid.Row="0"
                   x:Name="SearchBar"
                   Placeholder="Search by serial, brand, or model..."
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#3D3D3D}"
                   TextChanged="OnSearchTextChanged"/>

        <!-- Filter Chips -->
        <ScrollView Grid.Row="1" 
                    Orientation="Horizontal" 
                    HorizontalScrollBarVisibility="Never"
                    Padding="16,8">
            <HorizontalStackLayout Spacing="8">
                <Button x:Name="AllFilter"
                        Text="All"
                        BackgroundColor="#1976D2"
                        TextColor="White"
                        FontSize="12"
                        HeightRequest="32"
                        CornerRadius="16"
                        Padding="16,0"
                        Clicked="OnFilterClicked"/>
                <Button x:Name="GasFilter"
                        Text="Gas"
                        BackgroundColor="{AppThemeBinding Light={StaticResource PrimarySurface}, Dark=#1E3A5F}"
                        TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"
                        FontSize="12"
                        HeightRequest="32"
                        CornerRadius="16"
                        Padding="16,0"
                        Clicked="OnFilterClicked"/>
                <Button x:Name="ElectricFilter"
                        Text="Electric"
                        BackgroundColor="{AppThemeBinding Light={StaticResource PrimarySurface}, Dark=#1E3A5F}"
                        TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"
                        FontSize="12"
                        HeightRequest="32"
                        CornerRadius="16"
                        Padding="16,0"
                        Clicked="OnFilterClicked"/>
                <Button x:Name="ExpiringFilter"
                        Text="Expiring"
                        BackgroundColor="{AppThemeBinding Light={StaticResource WarningSurface}, Dark=#3D2D1F}"
                        TextColor="{AppThemeBinding Light={StaticResource SectionWarning}, Dark={StaticResource SectionWarningDark}}"
                        FontSize="12"
                        HeightRequest="32"
                        CornerRadius="16"
                        Padding="16,0"
                        Clicked="OnFilterClicked"/>
                <Button x:Name="R22Filter"
                        Text="R-22"
                        BackgroundColor="{AppThemeBinding Light={StaticResource ErrorSurface}, Dark=#3D1F1F}"
                        TextColor="{AppThemeBinding Light=#C62828, Dark=#EF9A9A}"
                        FontSize="12"
                        HeightRequest="32"
                        CornerRadius="16"
                        Padding="16,0"
                        Clicked="OnFilterClicked"/>
            </HorizontalStackLayout>
        </ScrollView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="2"
                           x:Name="LoadingIndicator"
                           IsRunning="False"
                           IsVisible="False"
                           Color="{AppThemeBinding Light=#1976D2, Dark={StaticResource SectionPrimaryDark}}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           HeightRequest="50"
                           WidthRequest="50"/>

        <!-- Assets List (Grouped by Customer) -->
        <RefreshView Grid.Row="2"
                     x:Name="RefreshViewControl"
                     Refreshing="OnRefreshing">
            <CollectionView x:Name="AssetCollection"
                            IsGrouped="True"
                            SelectionMode="Single"
                            SelectionChanged="OnAssetSelected"
                            EmptyView="No assets found. Add assets from a customer profile.">
                
                <CollectionView.GroupHeaderTemplate>
                    <DataTemplate>
                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource PrimarySurface}, Dark=#1E3A5F}" 
                                Padding="16,8" 
                                Margin="16,8,16,4"
                                StrokeShape="RoundRectangle 8"
                                Stroke="Transparent">
                            <HorizontalStackLayout Spacing="8">
                                <Label Text="{Binding Name}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource SectionPrimary}, Dark={StaticResource SectionPrimaryDark}}"/>
                                <Label Text="{Binding Count, StringFormat='({0} units)'}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"/>
                            </HorizontalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.GroupHeaderTemplate>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Execute">
                                    <SwipeItem Text="Delete"
                                               BackgroundColor="#F44336"
                                               Invoked="OnDeleteSwipe"
                                               BindingContext="{Binding}"/>
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <!-- Asset Card - Using Standard Card Style -->
                            <Border Style="{StaticResource CardStyle}"
                                    Margin="16,4">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnAssetTapped" CommandParameter="{Binding}"/>
                                </Border.GestureRecognizers>
                                
                                <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12" RowSpacing="6">
                                    
                                    <!-- Equipment Type Icon -->
                                    <Border Grid.Column="0" 
                                            Grid.RowSpan="2"
                                            WidthRequest="50" 
                                            HeightRequest="50"
                                            StrokeShape="RoundRectangle 25"
                                            BackgroundColor="{Binding EquipmentType, Converter={StaticResource EquipmentTypeColorConverter}}"
                                            Stroke="Transparent"
                                            VerticalOptions="Start">
                                        <Label Text="{Binding EquipmentType, Converter={StaticResource EquipmentTypeIconConverter}}"
                                               FontSize="20"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"/>
                                    </Border>

                                    <!-- Asset Info - Row 1 -->
                                    <VerticalStackLayout Grid.Column="1" 
                                                         Grid.Row="0"
                                                         VerticalOptions="Start"
                                                         Spacing="2">
                                        <Label Text="{Binding DisplayName}"
                                               FontSize="16" 
                                               FontAttributes="Bold" 
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"
                                               LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding Serial}"
                                               FontSize="13"
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                                               FontAttributes="Italic"/>
                                        <Label Text="{Binding EquipmentTypeDisplay}"
                                               FontSize="11"
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextTertiary}, Dark={StaticResource DarkTextTertiary}}"/>
                                    </VerticalStackLayout>

                                    <!-- Warranty Status Badge -->
                                    <VerticalStackLayout Grid.Column="2" 
                                                         Grid.Row="0"
                                                         VerticalOptions="Start"
                                                         HorizontalOptions="End"
                                                         Spacing="4">
                                        <Border BackgroundColor="{Binding IsWarrantyExpired, Converter={StaticResource WarrantyBadgeColorConverter}}"
                                                StrokeShape="RoundRectangle 12"
                                                Stroke="Transparent"
                                                Padding="8,4">
                                            <Label Text="{Binding DaysUntilWarrantyExpires, Converter={StaticResource WarrantyDaysConverter}}"
                                                   FontSize="10"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalTextAlignment="Center"/>
                                        </Border>
                                        <Label Text="{Binding AgeYears, StringFormat='{0} yrs old'}"
                                               FontSize="10"
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextTertiary}, Dark={StaticResource DarkTextTertiary}}"
                                               HorizontalTextAlignment="Center"
                                               IsVisible="{Binding AgeYears, Converter={StaticResource NullToBoolConverter}}"/>
                                    </VerticalStackLayout>

                                    <!-- Row 2: Capacity and Efficiency Info -->
                                    <HorizontalStackLayout Grid.Column="1"
                                                           Grid.ColumnSpan="2"
                                                           Grid.Row="1"
                                                           Spacing="6">
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource SuccessSurface}, Dark=#1B3D1F}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3"
                                                IsVisible="{Binding Tonnage, Converter={StaticResource NullToBoolConverter}}">
                                            <Label Text="{Binding CapacitySummary}"
                                                   FontSize="10"
                                                   TextColor="{AppThemeBinding Light=#2E7D32, Dark={StaticResource SectionSuccessDark}}"/>
                                        </Border>
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource PrimarySurface}, Dark=#1E3A5F}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3"
                                                IsVisible="{Binding SeerRating, Converter={StaticResource NullToBoolConverter}}">
                                            <Label Text="{Binding EfficiencySummary}"
                                                   FontSize="10"
                                                   TextColor="{AppThemeBinding Light=#1565C0, Dark={StaticResource SectionPrimaryDark}}"/>
                                        </Border>
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource WarningSurface}, Dark=#3D2D1F}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3">
                                            <HorizontalStackLayout Spacing="2">
                                                <Label Text="{Binding FuelType, Converter={StaticResource FuelTypeIconConverter}}"
                                                       FontSize="10"/>
                                                <Label Text="{Binding FuelType}"
                                                       FontSize="10"
                                                       TextColor="{AppThemeBinding Light=#E65100, Dark={StaticResource SectionWarningDark}}"/>
                                            </HorizontalStackLayout>
                                        </Border>
                                    </HorizontalStackLayout>

                                    <!-- Row 3: Refrigerant and Filter Info -->
                                    <HorizontalStackLayout Grid.Column="0"
                                                           Grid.ColumnSpan="3"
                                                           Grid.Row="2"
                                                           Spacing="6">
                                        <Border BackgroundColor="{Binding RefrigerantType, Converter={StaticResource RefrigerantColorConverter}}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3">
                                            <Label Text="{Binding RefrigerantType, Converter={StaticResource RefrigerantTypeConverter}}"
                                                   FontSize="10"
                                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                                        </Border>
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightInputBackground}, Dark={StaticResource DarkInputBackground}}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3"
                                                IsVisible="{Binding FilterSize, Converter={StaticResource StringToBoolConverter}}">
                                            <Label Text="{Binding FilterSize}"
                                                   FontSize="10"
                                                   TextColor="{AppThemeBinding Light=#616161, Dark={StaticResource DarkTextSecondary}}"/>
                                        </Border>
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource ErrorSurface}, Dark=#3D1F1F}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3"
                                                IsVisible="{Binding IsFilterDue, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <Label Text="Filter Due"
                                                   FontSize="10"
                                                   TextColor="{AppThemeBinding Light=#C62828, Dark=#EF9A9A}"/>
                                        </Border>
                                        <Border BackgroundColor="{AppThemeBinding Light={StaticResource WarningSurface}, Dark=#3D2D1F}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3"
                                                IsVisible="{Binding IsServiceDue, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <Label Text="Service Due"
                                                   FontSize="10"
                                                   TextColor="{AppThemeBinding Light=#E65100, Dark={StaticResource SectionWarningDark}}"/>
                                        </Border>
                                        <Border BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#3D2D3D}"
                                                StrokeShape="RoundRectangle 8"
                                                Stroke="Transparent"
                                                Padding="6,3"
                                                IsVisible="{Binding Site, Converter={StaticResource NullToBoolConverter}}">
                                            <Label Text="{Binding Site.Address}"
                                                   FontSize="10"
                                                   TextColor="{AppThemeBinding Light={StaticResource SectionPurple}, Dark={StaticResource SectionPurpleDark}}"
                                                   MaxLines="1"
                                                   LineBreakMode="TailTruncation"/>
                                        </Border>
                                    </HorizontalStackLayout>

                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Floating Action Button -->
        <Button Grid.Row="2"
                Text="+"
                FontSize="28"
                WidthRequest="60"
                HeightRequest="60"
                CornerRadius="30"
                BackgroundColor="#1976D2"
                TextColor="White"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20"
                Clicked="OnAddAssetClicked">
            <Button.Shadow>
                <Shadow Brush="Black" Offset="2,4" Radius="8" Opacity="0.25"/>
            </Button.Shadow>
        </Button>

    </Grid>

</ContentPage>