# OneManVan Docker Deployment - Visual Guide

```
???????????????????????????????????????????????????????????????????????????
?                    DEPLOYMENT WORKFLOW OVERVIEW                         ?
???????????????????????????????????????????????????????????????????????????

WINDOWS MACHINE                              PROXMOX LXC SERVER
(Development)                                (192.168.100.107)
?????????????????                            ??????????????????

????????????????????
?  Solution Files  ?
?  - Web Project   ?
?  - Shared Project?
?  - Dockerfiles   ?
????????????????????
         ?
         ? Step 1: Run create-deployment-package.ps1
         ?
????????????????????
? deployment.zip   ?
?   (~5-10 MB)     ?
????????????????????
         ?
         ? Step 2: Transfer (SCP/WinSCP/FileZilla)
         ?
                                             ????????????????????
                                             ? deployment.zip   ?
                                             ?   /root/         ?
                                             ????????????????????
                                                      ?
                                                      ? Step 3: Extract & Deploy
                                                      ?
                                             ????????????????????
                                             ? /opt/onemanvan/  ?
                                             ?  - docker-compose?
                                             ?  - Dockerfiles   ?
                                             ?  - Source code   ?
                                             ????????????????????
                                                      ?
                                                      ? ./deploy-to-docker.sh
                                                      ?
                                             ????????????????????????????
                                             ?   DOCKER CONTAINERS      ?
                                             ????????????????????????????
                                             ?                          ?
                                             ?  ???????????????????    ?
                                             ?  ?  tradeflow-db   ?    ?
                                             ?  ?  SQL Server     ?    ?
                                             ?  ?  Port: 1433     ?    ?
                                             ?  ???????????????????    ?
                                             ?           ?              ?
                                             ?           ?              ?
                                             ?  ???????????????????    ?
                                             ?  ? tradeflow-webui ?    ?
                                             ?  ?  .NET 10 Web    ?    ?
                                             ?  ?  Port: 5000     ?    ?
                                             ?  ???????????????????    ?
                                             ?                          ?
                                             ????????????????????????????


NETWORK ACCESS (After Deployment)
??????????????????????????????????

???????????????????
?  Any Device on  ?
?  Local Network  ?
?  192.168.100.x  ?
???????????????????
         ?
         ? HTTP Request
         ? http://192.168.100.107:5000
         ?
???????????????????????????
?  Proxmox LXC Server     ?
?  192.168.100.107        ?
???????????????????????????
?                         ?
?  ????????????????????  ?
?  ?  Web UI (Port    ?  ?????? Web Browser Access
?  ?  5000)           ?  ?
?  ????????????????????  ?
?           ?             ?
?           ?             ?
?  ????????????????????  ?
?  ?  SQL Server      ?  ?????? Mobile/Desktop App
?  ?  (Port 1433)     ?  ?      Direct DB Connection
?  ????????????????????  ?
?                         ?
???????????????????????????


FILE STRUCTURE IN DEPLOYMENT.ZIP
?????????????????????????????????

deployment.zip
??? OneManVan.Web/
?   ??? Dockerfile ?
?   ??? Program.cs
?   ??? appsettings.json
?   ??? Components/
?   ?   ??? Pages/
?   ?   ?   ??? Customers/
?   ?   ?   ??? Invoices/
?   ?   ?   ??? Jobs/
?   ?   ?   ??? Assets/
?   ?   ?   ??? Settings/
?   ?   ??? Layout/
?   ??? Services/
?
??? OneManVan.Shared/
?   ??? Data/
?   ?   ??? OneManVanDbContext.cs
?   ??? Models/
?   ?   ??? Customer.cs
?   ?   ??? Invoice.cs
?   ?   ??? Job.cs
?   ?   ??? ...
?   ??? Services/
?       ??? DatabaseConfigService.cs
?       ??? ...
?
??? docker/
?   ??? init/
?       ??? 01-create-database.sql
?       ??? 02-seed-data.sql
?       ??? 03-add-warranty-claims.sql
?
??? docker-compose-full.yml ?
??? .dockerignore
??? deploy-to-docker.sh ?
??? README.md
??? QUICKSTART.txt

? = Critical deployment files


CONTAINER ARCHITECTURE
??????????????????????

???????????????????????????????????????????????????????????????
?                      Docker Host (LXC)                      ?
???????????????????????????????????????????????????????????????
?                                                             ?
?  ????????????????????????????????????????????????????????  ?
?  ?              tradeflow-net (Bridge Network)          ?  ?
?  ?                                                      ?  ?
?  ?  ??????????????????????   ??????????????????????   ?  ?
?  ?  ?  tradeflow-db      ?   ?  tradeflow-webui   ?   ?  ?
?  ?  ?                    ?   ?                    ?   ?  ?
?  ?  ?  SQL Server 2022   ?????  .NET 10 Blazor    ?   ?  ?
?  ?  ?  Express           ?   ?  Server            ?   ?  ?
?  ?  ?                    ?   ?                    ?   ?  ?
?  ?  ?  Internal: 1433    ?   ?  Internal: 8080    ?   ?  ?
?  ?  ?  External: 1433    ?   ?  External: 5000    ?   ?  ?
?  ?  ?                    ?   ?                    ?   ?  ?
?  ?  ??????????????????????   ??????????????????????   ?  ?
?  ?           ?                        ?               ?  ?
?  ??????????????????????????????????????????????????????  ?
?              ?                        ?                  ?
?              ?                        ?                  ?
?  ???????????????????????  ????????????????????????????  ?
?  ?  Volume:            ?  ?  Volume:                 ?  ?
?  ?  tradeflow-sqldata  ?  ?  tradeflow-webui-data    ?  ?
?  ?  (Database files)   ?  ?  (Config & Settings)     ?  ?
?  ???????????????????????  ????????????????????????????  ?
?                                                          ?
????????????????????????????????????????????????????????????


DATA FLOW
?????????

User Browser
     ?
     ? HTTP Request (Port 5000)
     ?
???????????????????
?  Web UI         ?
?  (Blazor Server)?
???????????????????
?  ?????????????  ?
?  ? Program.cs?  ?
?  ?????????????  ?
?        ?        ?
?        ?        ?
?  ?????????????  ?
?  ?DbContext  ?  ?
?  ?Factory    ?  ?
?  ?????????????  ?
???????????????????
         ?
         ? SQL Connection (Internal: sqlserver:1433)
         ?
???????????????????
?  SQL Server     ?
?  (Container)    ?
???????????????????
?  TradeFlowFSM   ?
?  Database       ?
?  ?????????????  ?
?  ?  Tables:  ?  ?
?  ? Customers ?  ?
?  ? Invoices  ?  ?
?  ? Jobs      ?  ?
?  ? Assets    ?  ?
?  ? ...       ?  ?
?  ?????????????  ?
???????????????????


DEPLOYMENT SCRIPT FLOW
??????????????????????

deploy-to-docker.sh
        ?
        ??? Check if Docker installed
        ?   ??? If not: Install Docker
        ?
        ??? Check if Docker Compose installed
        ?   ??? If not: Install Docker Compose
        ?
        ??? Create /opt/onemanvan directory
        ?
        ??? Extract deployment.zip
        ?
        ??? Stop existing containers (if any)
        ?
        ??? Build new containers
        ?   ??? Build Web UI image (multi-stage)
        ?   ?   ??? Restore NuGet packages
        ?   ?   ??? Compile .NET code
        ?   ?   ??? Publish optimized build
        ?   ?
        ?   ??? Pull SQL Server image
        ?
        ??? Start containers
        ?   ??? Start SQL Server
        ?   ?   ??? Wait for health check
        ?   ?
        ?   ??? Start Web UI
        ?       ??? Connect to SQL Server
        ?
        ??? Initialize databases
        ?   ??? Run SQL init scripts
        ?   ??? Create tables
        ?
        ??? Display access information


CONFIGURATION PRIORITY
??????????????????????

When Web UI starts, it checks for database config in this order:

1. appsettings.json
   ??? ConnectionStrings:BusinessConnection
         ? Not found?
         
2. Docker Environment Variables
   ??? CONNECTIONSTRINGS__BUSINESSCONNECTION
         ? Not found?
         
3. Database Config File (from UI)
   ??? /app/AppData/database-config.json
         ? Not found?
         
4. SQLite Fallback
   ??? /app/AppData/OneManVan.db


HEALTH CHECKS
?????????????

??????????????????
?  Docker Engine ?
??????????????????
         ?
         ? Every 30 seconds
         ?
???????????????????????
?  SQL Server Health  ?
?  Check              ?
???????????????????????
?  sqlcmd -S          ?
?  localhost -U sa    ?
?  -Q "SELECT 1"      ?
???????????????????????
         ?
         ??? Success: Container healthy
         ??? Fail: Restart container
         
         
??????????????????????
?  Web UI Health     ?
?  Check             ?
??????????????????????
?  curl -f           ?
?  http://localhost: ?
?  8080/health       ?
??????????????????????
         ?
         ??? Success: Container healthy
         ??? Fail: Restart container


PORTS MAPPING
?????????????

Host (LXC)           Container
??????????           ?????????

1433        ???????  1433      (SQL Server)
5000        ???????  8080      (Web UI HTTP)
5001        ???????  8081      (Web UI HTTPS - if configured)


VOLUME PERSISTENCE
??????????????????

Container Data                     Host Storage
??????????????                     ????????????

/var/opt/mssql/data    ???  Docker Volume: tradeflow-sqldata
/var/opt/mssql/log     ???  Docker Volume: tradeflow-sqllogs
/var/opt/mssql/backup  ???  Docker Volume: tradeflow-backups
/app/AppData           ???  Docker Volume: tradeflow-webui-data

These volumes persist even when containers are removed!


BACKUP STRATEGY
???????????????

??????????????????????
?  Scheduled Backup  ?
?  (cron job)        ?
??????????????????????
         ?
         ? Daily at 2 AM
         ?
??????????????????????????????????
?  docker exec tradeflow-db      ?
?  sqlcmd -Q "BACKUP DATABASE"   ?
??????????????????????????????????
         ?
         ?
??????????????????????????????????
?  /var/opt/mssql/backup/        ?
?  TradeFlowFSM-2025-01-15.bak   ?
??????????????????????????????????
         ?
         ? Copy to safe location
         ?
??????????????????????????????????
?  /backup/onemanvan/            ?
?  or network storage            ?
??????????????????????????????????
```

## Quick Command Reference

### Essential Commands:
```bash
# Check status
docker ps

# View logs
docker logs tradeflow-webui -f

# Restart services
cd /opt/onemanvan
docker-compose -f docker-compose-full.yml restart

# Stop all
docker-compose -f docker-compose-full.yml down

# Start all
docker-compose -f docker-compose-full.yml up -d
```

### Troubleshooting:
```bash
# Container won't start
docker logs tradeflow-webui
docker logs tradeflow-db

# Check resource usage
docker stats

# Rebuild from scratch
docker-compose -f docker-compose-full.yml down -v
docker-compose -f docker-compose-full.yml up -d --build
```
