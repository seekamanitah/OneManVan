@using OneManVan.Shared.Utilities

<input type="tel" 
       class="form-control @CssClass" 
       placeholder="@Placeholder"
       value="@DisplayValue"
       @oninput="OnInput"
       @onblur="OnBlur"
       maxlength="12" 
       inputmode="tel" />

@if (!string.IsNullOrEmpty(ValidationMessage))
{
    <div class="invalid-feedback d-block">@ValidationMessage</div>
}

@code {
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public string? Placeholder { get; set; } = "xxx-xxx-xxxx";
    [Parameter] public string? CssClass { get; set; }
    [Parameter] public bool Required { get; set; }
    
    private string? DisplayValue { get; set; }
    private string? ValidationMessage { get; set; }
    
    protected override void OnParametersSet()
    {
        DisplayValue = PhoneNumberFormatter.Format(Value);
    }
    
    private async Task OnInput(ChangeEventArgs e)
    {
        var input = e.Value?.ToString();
        DisplayValue = PhoneNumberFormatter.FormatAsTyping(input);
        
        var unformatted = PhoneNumberFormatter.Unformat(DisplayValue);
        await ValueChanged.InvokeAsync(unformatted);
        
        if (Required && string.IsNullOrWhiteSpace(unformatted))
        {
            ValidationMessage = "Phone number is required";
        }
        else if (!string.IsNullOrWhiteSpace(unformatted) && !PhoneNumberFormatter.IsValid(unformatted))
        {
            ValidationMessage = "Invalid phone number format";
        }
        else
        {
            ValidationMessage = null;
        }
    }
    
    private void OnBlur()
    {
        DisplayValue = PhoneNumberFormatter.Format(Value);
        StateHasChanged();
    }
}
