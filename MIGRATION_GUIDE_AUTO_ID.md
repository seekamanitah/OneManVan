# Database Migration - AssetNumber & InventoryNumber

## ? What Was Completed

### 1. Code Changes
- ? Created `OneManVan.Shared/Constants/EntityIdPrefixes.cs` with centralized ID prefixes
- ? Updated `CsvImportService.cs` to use constants instead of magic strings
- ? Added `AssetNumber` field to Asset model
- ? Added `InventoryNumber` field to InventoryItem model
- ? Added database indexes in `OneManVanDbContext.cs`
- ? Added CSP and security headers in `Program.cs`
- ? Fixed error messages to be generic (security)

### 2. Migration Scripts Created
- ? `Migrations/AddAutoGeneratedIdFields.sql` - SQL Server version
- ? `Migrations/AddAutoGeneratedIdFields_SQLite.sql` - SQLite version

### 3. Migration Helper Scripts
- ? `ApplyAutoIdMigration.ps1` - SQLite migration
- ? `ApplyAutoIdMigration_SqlServer.ps1` - SQL Server migration
- ? `ApplyAutoIdMigration_Auto.ps1` - Auto-detect database

---

## ?? How to Apply the Migration

### Option 1: Automatic (Recommended)
```powershell
# Auto-detects your database and applies the correct migration
.\ApplyAutoIdMigration_Auto.ps1
```

### Option 2: SQLite (Local Development)
```powershell
.\ApplyAutoIdMigration.ps1
```

### Option 3: SQL Server (Docker/Production)
```powershell
.\ApplyAutoIdMigration_SqlServer.ps1
```

### Option 4: Manual Application

#### For SQLite
1. Open `OneManVan.Web/AppData/OneManVan.db` in **DB Browser for SQLite**
2. Go to **Execute SQL** tab
3. Copy and paste the contents of `Migrations/AddAutoGeneratedIdFields_SQLite.sql`
4. Click **Execute** (F5)

#### For SQL Server
1. Open **SSMS** or **Azure Data Studio**
2. Connect to your SQL Server (localhost,1433)
3. Open `Migrations/AddAutoGeneratedIdFields.sql`
4. Execute (F5)

---

## ?? What the Migration Does

### 1. Adds New Columns
| Table | Column | Type | Description |
|-------|--------|------|-------------|
| Assets | AssetNumber | NVARCHAR(20) | Auto-generated: AST-0001, AST-0002 |
| InventoryItems | InventoryNumber | NVARCHAR(20) | Auto-generated: INV-0001, INV-0002 |

### 2. Creates Indexes
- `IX_Assets_AssetNumber` - For fast lookups
- `IX_InventoryItems_InventoryNumber` - For fast lookups

### 3. Optional Backfill
The migration includes commented-out SQL to backfill existing records:
```sql
-- Uncomment these lines to generate IDs for existing records:
-- UPDATE Assets SET AssetNumber = 'AST-' || printf('%04d', Id) WHERE AssetNumber IS NULL;
-- UPDATE InventoryItems SET InventoryNumber = 'INV-' || printf('%04d', Id) WHERE InventoryNumber IS NULL;
```

---

## ? Features After Migration

### Auto-Generated IDs
All new records will automatically get sequential IDs:

| Entity | Current Status | Format | Example |
|--------|---------------|--------|---------|
| Customer | ? Working | C-0001 | C-0001, C-0002, C-0003 |
| Product | ? Working | PROD-0001 | PROD-0001, PROD-0002 |
| Asset | ?? After migration | AST-0001 | AST-0001, AST-0002 |
| Inventory | ?? After migration | INV-0001 | INV-0001, INV-0002 |

### Import Behavior
- If ID is provided in CSV ? Uses provided ID
- If ID is blank ? Auto-generates next sequential ID
- No duplicate IDs possible
- Safe for multiple imports

---

## ?? Verify Migration Success

### SQLite
```sql
-- Check if columns exist
PRAGMA table_info(Assets);
PRAGMA table_info(InventoryItems);

-- Check if indexes exist
SELECT name FROM sqlite_master WHERE type='index' AND tbl_name='Assets';
```

### SQL Server
```sql
-- Check if columns exist
SELECT * FROM sys.columns 
WHERE object_id = OBJECT_ID('Assets') AND name = 'AssetNumber';

-- Check if indexes exist
SELECT * FROM sys.indexes 
WHERE name = 'IX_Assets_AssetNumber';
```

---

## ?? Next Steps After Migration

1. **Rebuild the solution** to ensure all code compiles:
   ```powershell
   dotnet build
   ```

2. **Test the import functionality**:
   - Import customers (should see C-0001, C-0002)
   - Import products (should see PROD-0001)
   - Future: Asset/Inventory imports will use new fields

3. **Commit your changes**:
   ```powershell
   git add -A
   git commit -m "Feature: Auto-ID generation with database migration
   
   - Added AssetNumber and InventoryNumber fields
   - Created EntityIdPrefixes constants
   - Applied database migration
   - Added indexes for performance
   - Fixed code review issues (CSP headers, error messages)"
   
   git push origin master
   ```

---

## ?? Files Changed

### New Files
- `OneManVan.Shared/Constants/EntityIdPrefixes.cs`
- `Migrations/AddAutoGeneratedIdFields.sql`
- `Migrations/AddAutoGeneratedIdFields_SQLite.sql`
- `ApplyAutoIdMigration.ps1`
- `ApplyAutoIdMigration_SqlServer.ps1`
- `ApplyAutoIdMigration_Auto.ps1`

### Modified Files
- `OneManVan.Shared/Models/Asset.cs`
- `OneManVan.Shared/Models/InventoryItem.cs`
- `OneManVan.Shared/Data/OneManVanDbContext.cs`
- `OneManVan.Web/Services/Import/CsvImportService.cs`
- `OneManVan.Web/Controllers/ImportController.cs`
- `OneManVan.Web/Program.cs`

---

## ??? Troubleshooting

### "sqlite3 command not found"
Install SQLite tools: https://www.sqlite.org/download.html
Or use manual application with DB Browser

### "sqlcmd not found"
Install SQL Server Command Line Utilities:
https://learn.microsoft.com/en-us/sql/tools/sqlcmd-utility

### "Database not found"
Check your connection string in `appsettings.json`:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=AppData/OneManVan.db"
  }
}
```

### "Column already exists"
Migration has already been applied - no action needed!

---

**Migration is ready! Run `.\ApplyAutoIdMigration_Auto.ps1` to apply it now.**
