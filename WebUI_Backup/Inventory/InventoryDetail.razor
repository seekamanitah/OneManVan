@page "/inventory/{Id:int}"
@using Microsoft.EntityFrameworkCore
@using OneManVan.Shared.Data
@using OneManVan.Shared.Models
@attribute [Authorize]
@inject IDbContextFactory<OneManVanDbContext> DbFactory
@inject NavigationManager Navigation

<PageTitle>@(inventory?.Product?.Name ?? "Inventory") - TradeFlow</PageTitle>

<div class="container-fluid py-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
        </div>
    }
    else if (inventory == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>Inventory item not found
        </div>
    }
    else
    {
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/inventory">Inventory</a></li>
                        <li class="breadcrumb-item active">@inventory.Product?.Name</li>
                    </ol>
                </nav>
                <div class="d-flex align-items-center">
                    <div class="avatar-circle bg-warning bg-opacity-10 text-warning me-3" style="width: 60px; height: 60px; font-size: 24px;">
                        <i class="bi bi-boxes"></i>
                    </div>
                    <div>
                        <h1 class="h2 mb-1">@inventory.Product?.Name</h1>
                        <div class="d-flex gap-2">
                            @if (!string.IsNullOrEmpty(inventory.Product?.SKU))
                            {
                                <span class="badge bg-secondary">@inventory.Product.SKU</span>
                            }
                            @if (!string.IsNullOrEmpty(inventory.Location))
                            {
                                <span class="badge bg-info">@inventory.Location</span>
                            }
                            <span class="badge @GetStockStatusBadge()">
                                @GetStockStatus()
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" @onclick="GoBack">
                    <i class="bi bi-arrow-left me-2"></i>Back
                </button>
                <button class="btn btn-success" @onclick="AdjustStock">
                    <i class="bi bi-plus-slash-minus me-2"></i>Adjust Stock
                </button>
                <button class="btn btn-primary" @onclick="EditInventory">
                    <i class="bi bi-pencil me-2"></i>Edit
                </button>
            </div>
        </div>

        <div class="row g-3">
            <!-- Inventory Information -->
            <div class="col-md-8">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">Stock Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="text-muted small d-block mb-1">Product</label>
                                <div>
                                    <div class="fw-semibold">@inventory.Product?.Name</div>
                                    @if (!string.IsNullOrEmpty(inventory.Product?.Manufacturer))
                                    {
                                        <small class="text-muted">@inventory.Product.Manufacturer @inventory.Product.Model</small>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small d-block mb-1">Location</label>
                                <span>@(inventory.Location ?? "—")</span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block mb-1">Current Stock</label>
                                <div class="@GetStockQuantityClass()">
                                    <span class="h3 mb-0">@inventory.Quantity</span>
                                    <span class="text-muted"> units</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block mb-1">Reorder Point</label>
                                <span class="h5 mb-0">@inventory.ReorderPoint</span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block mb-1">Reorder Quantity</label>
                                <span class="h5 mb-0">@inventory.ReorderQuantity</span>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small d-block mb-1">Last Stock Update</label>
                                <span>@(inventory.LastStockUpdate?.ToString("MMM dd, yyyy h:mm tt") ?? "—")</span>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small d-block mb-1">Updated By</label>
                                <span>@(inventory.LastUpdatedBy ?? "—")</span>
                            </div>
                            @if (!string.IsNullOrEmpty(inventory.Notes))
                            {
                                <div class="col-12">
                                    <label class="text-muted small d-block mb-1">Notes</label>
                                    <p class="mb-0">@inventory.Notes</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Stock History -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">Recent Stock Changes</h5>
                    </div>
                    <div class="card-body">
                        @if (stockHistory.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Quantity</th>
                                            <th>New Balance</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var change in stockHistory.Take(10))
                                        {
                                            <tr>
                                                <td>@change.Date.ToString("MMM dd, yyyy")</td>
                                                <td>
                                                    <span class="badge @(change.Type == "In" ? "bg-success" : "bg-danger")">
                                                        @change.Type
                                                    </span>
                                                </td>
                                                <td>@change.Quantity</td>
                                                <td>@change.NewBalance</td>
                                                <td>@change.Reason</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-clock-history fs-3 mb-2 d-block"></i>
                                <p class="mb-0">No stock history available</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Stock Status -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">Stock Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 pb-3 border-bottom">
                            <label class="text-muted small d-block mb-1">Status</label>
                            <span class="badge @GetStockStatusBadge() fs-6">@GetStockStatus()</span>
                        </div>
                        <div class="mb-3 pb-3 border-bottom">
                            <label class="text-muted small d-block mb-1">Stock Level</label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar @GetProgressBarClass()" 
                                     style="width: @GetStockPercentage()%"
                                     role="progressbar">
                                    @inventory.Quantity
                                </div>
                            </div>
                            <small class="text-muted">Reorder at @inventory.ReorderPoint</small>
                        </div>
                        @if (NeedsReorder())
                        {
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Action Required:</strong> Stock is at or below reorder point. 
                                Consider ordering @inventory.ReorderQuantity units.
                            </div>
                        }
                    </div>
                </div>

                <!-- Product Info -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">Product Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-muted small d-block mb-1">Price</label>
                            <span class="h5 mb-0">@inventory.Product?.Price.ToString("C")</span>
                        </div>
                        @if (inventory.Product?.Cost.HasValue == true)
                        {
                            <div class="mb-3">
                                <label class="text-muted small d-block mb-1">Cost</label>
                                <span>@inventory.Product.Cost.Value.ToString("C")</span>
                            </div>
                        }
                        <div class="mb-3">
                            <label class="text-muted small d-block mb-1">Total Value</label>
                            <span class="h5 mb-0">@GetTotalValue().ToString("C")</span>
                        </div>
                        <div>
                            <label class="text-muted small d-block mb-1">Category</label>
                            <span>@(inventory.Product?.Category ?? "—")</span>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" @onclick="AdjustStock">
                                <i class="bi bi-plus-slash-minus me-2"></i>Adjust Stock
                            </button>
                            <button class="btn btn-outline-primary" @onclick="ViewProduct">
                                <i class="bi bi-box me-2"></i>View Product
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="PrintReport">
                                <i class="bi bi-printer me-2"></i>Print Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .avatar-circle {
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
</style>

@code {
[Parameter]
public int Id { get; set; }

private bool isLoading = true;
private InventoryItem? inventory;
    private List<StockChange> stockHistory = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadInventoryAsync();
    }

    private async Task LoadInventoryAsync()
    {
        try
        {
            isLoading = true;

            await using var db = await DbFactory.CreateDbContextAsync();
            
            inventory = await db.Inventory
                .Include(i => i.Product)
                .AsNoTracking()
                .FirstOrDefaultAsync(i => i.Id == Id);

            // Load stock history (simulated for now - you can implement a proper StockHistory table)
            if (inventory != null)
            {
                stockHistory = new List<StockChange>
                {
                    new StockChange { Date = DateTime.Now.AddDays(-1), Type = "In", Quantity = 10, NewBalance = inventory.Quantity, Reason = "Purchase Order #1234" },
                    new StockChange { Date = DateTime.Now.AddDays(-3), Type = "Out", Quantity = 5, NewBalance = inventory.Quantity - 10, Reason = "Job #456" },
                    new StockChange { Date = DateTime.Now.AddDays(-7), Type = "In", Quantity = 20, NewBalance = inventory.Quantity - 5, Reason = "Initial Stock" }
                };
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetStockStatus()
    {
        if (inventory!.Quantity == 0)
            return "Out of Stock";
        if (inventory.Quantity <= inventory.ReorderPoint)
            return "Low Stock";
        return "In Stock";
    }

    private string GetStockStatusBadge()
    {
        if (inventory!.Quantity == 0)
            return "bg-danger";
        if (inventory.Quantity <= inventory.ReorderPoint)
            return "bg-warning";
        return "bg-success";
    }

    private string GetStockQuantityClass()
    {
        if (inventory!.Quantity == 0)
            return "text-danger";
        if (inventory.Quantity <= inventory.ReorderPoint)
            return "text-warning";
        return "text-success";
    }

    private string GetProgressBarClass()
    {
        if (inventory!.Quantity == 0)
            return "bg-danger";
        if (inventory.Quantity <= inventory.ReorderPoint)
            return "bg-warning";
        return "bg-success";
    }

    private double GetStockPercentage()
    {
        var maxStock = Math.Max(inventory!.ReorderPoint * 2, inventory.Quantity);
        return (inventory.Quantity / (double)maxStock) * 100;
    }

    private bool NeedsReorder()
    {
        return inventory!.Quantity <= inventory.ReorderPoint;
    }

    private decimal GetTotalValue()
    {
        return inventory!.Quantity * (inventory.Product?.Price ?? 0);
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/inventory");
    }

    private void EditInventory()
    {
        Navigation.NavigateTo($"/inventory/{Id}/edit");
    }

    private void AdjustStock()
    {
        Navigation.NavigateTo($"/inventory/{Id}/adjust");
    }

    private void ViewProduct()
    {
        if (inventory?.ProductId != null)
        {
            Navigation.NavigateTo($"/products/{inventory.ProductId}");
        }
    }

    private void PrintReport()
    {
        // TODO: Implement print report
    }

    private class StockChange
    {
        public DateTime Date { get; set; }
        public string Type { get; set; } = "";
        public int Quantity { get; set; }
        public int NewBalance { get; set; }
        public string Reason { get; set; } = "";
    }
}
